package com.example.mailapplication;

import android.animation.Animator;
import android.animation.ValueAnimator;
import android.content.Intent;

import androidx.activity.result.ActivityResultCallback;
import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.content.ContextCompat;
import androidx.core.view.GestureDetectorCompat;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import android.database.Cursor;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.view.GestureDetector;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewPropertyAnimator;
import android.view.animation.AccelerateInterpolator;
import android.view.animation.Animation;
import android.view.animation.AnimationUtils;
import android.view.inputmethod.InputMethodManager;
import android.widget.EditText;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.view.ViewGroup;
import android.view.LayoutInflater;
import android.widget.TextView;


import static android.view.View.VISIBLE;
import static android.view.View.GONE;

import java.lang.ref.WeakReference;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;


public class EMailMessageComposing extends AppCompatActivity {
    LinearLayout toLayout;
    LinearLayout bccLayout;
    LinearLayout ccLayout;
    RecipientsLayoutEnter toLayoutEnter;
    RecipientsLayoutEnter bccLayoutEnter;
    RecipientsLayoutEnter ccLayoutEnter;
    View contentLayoutClickable;
    View shadow;
    View top;
    HashMap<LayoutPart, String> recipientsLayoutParts;
    int toLayoutPartEditCount;
    boolean modeEditLayoutPartOn;
    boolean hasAttachments;
    EMailService recipientsLayoutTextChangedListener;
    ArrayList<Attachment> attachments;
    ActivityResultLauncher<String> resultLauncher;


    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.email_message_composing);
        View fragmentLoadingLayout = findViewById(R.id.email_message_composing_fragment_loading_layout);
        fragmentLoadingLayout.setVisibility(GONE);
        EMailService.setCurrentActivity(this, R.id.email_message_composing_fragment_loading_layout);
        FrameLayout fromLayout = findViewById(R.id.email_message_composing_from_layout);
        String currentUserEMailAddress = EMailService.getCurrentUserEMailAddress();
        LayoutPart fromLayoutPart = new LayoutPart();
        fromLayoutPart.setLayoutPartData(currentUserEMailAddress, true, true);
        int fromLayoutId = fromLayout.getId();
        getSupportFragmentManager().beginTransaction()
                .add(fromLayoutId, fromLayoutPart)
                .commit();
        toLayout = findViewById(R.id.email_message_composing_to_layout);
        recipientsLayoutTextChangedListener = new EMailService() {
            public void onTextChanged(CharSequence text, int start, int count, int after) {
                final int charactersCount = text.length();
                if (charactersCount > 0) {
                    char characterLast = text.charAt(charactersCount - 1);
                    if (characterLast == ' ') {
                        if (charactersCount != 1) {
                            final HashMap<String, Object> recipientsLayoutData=getRecipientsLayoutData();
                            if (modeEditLayoutPartOn) {
                                RecipientsLayoutEnter recipientsLayoutEnterCurrent=(RecipientsLayoutEnter) recipientsLayoutData.get("enter");
                                recipientsLayoutEnterCurrent.getView().setAlpha(0);
                                makeToLayoutPartFromRecipientsLayoutEnter(recipientsLayoutEnterCurrent, (String) recipientsLayoutData.get("type"));
                                FrameLayout recipientsLayoutEnterLayout = new FrameLayout(EMailMessageComposing.this);
                                recipientsLayoutEnterLayout.setId(View.generateViewId());
                                RecipientsLayoutEnter recipientsLayoutEnter = new RecipientsLayoutEnter(recipientsLayoutEnterLayout, this, true);
                                LinearLayout recipientsLayoutCurrent=(LinearLayout) recipientsLayoutData.get("layout");
                                recipientsLayoutCurrent.addView(recipientsLayoutEnterLayout, 0);
                                getSupportFragmentManager().beginTransaction()
                                        .add(recipientsLayoutEnterLayout.getId(), recipientsLayoutEnter)
                                        .commitNow();
                                modeEditLayoutPartOn = false;
                            } else {
                                final RecipientsLayoutEnter recipientsLayoutCurrentEnter=(RecipientsLayoutEnter) recipientsLayoutData.get("enter");
                                final String eMailAddress = recipientsLayoutCurrentEnter.enter.getText().toString();
                                final LinearLayout recipientsLayoutCurrent=(LinearLayout) recipientsLayoutData.get("layout");
                                addToLayoutPart(recipientsLayoutCurrent, (String) recipientsLayoutData.get("type"), eMailAddress,  recipientsLayoutCurrent.getChildCount());
                                recipientsLayoutCurrentEnter.enter.setText("");
                            }
                        }
                    }
                }
            }
        };
        FrameLayout toLayoutEnterLayout = new FrameLayout(this);
        toLayoutEnterLayout.setId(View.generateViewId());
        toLayoutEnter = new RecipientsLayoutEnter(toLayoutEnterLayout, recipientsLayoutTextChangedListener, false);
        toLayout.addView(toLayoutEnterLayout);
        getSupportFragmentManager().beginTransaction()
                .add(toLayoutEnterLayout.getId(), toLayoutEnter)
                .commitNow();
        EditText subject = findViewById(R.id.email_message_composing_subject);
        subject.setFocusable(false);
        EditText content = findViewById(R.id.email_message_composing_content);
        content.setFocusable(false);
        ImageView back = findViewById(R.id.email_message_composing_back);
        ImageView attachmentIcon = findViewById(R.id.email_message_composing_attachment_icon);
        ImageView send = findViewById(R.id.email_message_composing_send);
        ImageView addCcBcc=findViewById(R.id.email_message_composing_add_cc_bcc);
        View recipientsLayoutClickable = findViewById(R.id.email_message_composing_recipients_layout_clickable);
        contentLayoutClickable = findViewById(R.id.email_message_composing_content_layout_clickable_all);
        contentLayoutClickable.bringToFront();
        View subjectLayoutClickable=findViewById(R.id.email_message_composing_subject_layout_clickable);
        FrameLayout attachmentMenuLayout = findViewById(R.id.email_message_composing_attachment_menu_layout);
        attachmentMenuLayout.bringToFront();
        Drawable attachmentMenuBackground = ContextCompat.getDrawable(this, R.drawable.background_email_message_composing_attachment_menu);
        top = findViewById(R.id.email_message_composing_top);
        View popUpWindowLayout = findViewById(R.id.email_message_composing_pop_up_window_layout);
        popUpWindowLayout.setVisibility(GONE);
        EMailService eMailMessageComposingClickListener = new EMailService() {
            EMailService confirmingSendingEmptyMessageClickListener;
            boolean attachmentMenuShown;
            boolean ccBccShown;

            public void onClick(View view) {
                final int viewId = view.getId();
                if (viewId == back.getId()) {
                    Intent intent = new Intent(EMailMessageComposing.this, MenuMain.class);
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
                    startActivity(intent);
                } else if (viewId == addCcBcc.getId()) {
                    addCcBcc.setClickable(false);
                    final FragmentManager fragmentManager=getSupportFragmentManager();
                    if (!ccBccShown) {
                        System.out.println("hellO");
                        final CcBcc ccBcc = new CcBcc();
                        FrameLayout ccBccLayout = findViewById(R.id.email_message_composing_cc_bcc_layout);
                        getSupportFragmentManager().beginTransaction()
                                .add(ccBccLayout.getId(), ccBcc, "ccBcc")
                                .commitNow();
                        FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
                        View ccBccView = ccBcc.getView();
                        LinearLayout bccLayout = ccBccView.findViewById(R.id.email_message_composing_bcc_layout);
                        FrameLayout bccLayoutEnterLayout = new FrameLayout(EMailMessageComposing.this);
                        bccLayoutEnterLayout.setId(View.generateViewId());
                        bccLayout.addView(bccLayoutEnterLayout);
                        RecipientsLayoutEnter bccLayoutEnter = new RecipientsLayoutEnter(bccLayoutEnterLayout,
                                recipientsLayoutTextChangedListener,
                                false);
                        fragmentTransaction.add(bccLayoutEnterLayout.getId(), bccLayoutEnter, "Bcc");
                        LinearLayout ccLayout = ccBccView.findViewById(R.id.email_message_composing_cc_layout);
                        FrameLayout ccLayoutEnterLayout = new FrameLayout(EMailMessageComposing.this);
                        ccLayoutEnterLayout.setId(View.generateViewId());
                        ccLayout.addView(ccLayoutEnterLayout);
                        RecipientsLayoutEnter ccLayoutEnter = new RecipientsLayoutEnter(ccLayoutEnterLayout,
                                recipientsLayoutTextChangedListener,
                                false);
                        fragmentTransaction.add(ccLayoutEnterLayout.getId(), ccLayoutEnter, "Cc").commitNow();
                        final int viewMeasurer = View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED);
                        ccBccView.measure(viewMeasurer, viewMeasurer);
                        ccBccView.setLayoutParams(new FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT,
                                ccBccView.getMeasuredHeight()));
                        final View subjectContentLayout=findViewById(R.id.email_message_composing_subject_content_layout);
                        final ViewPropertyAnimator subjectContentLayoutAnimator=subjectContentLayout.animate();
                        boolean ccBccShownFirstTime=subjectContentLayoutAnimator.getDuration()==300;
                        // such weird animation duration numbers are needed to be able to create only one instance of AnimatorListener
                        if (ccBccShownFirstTime) {
                            System.out.println("hello");
                            subjectContentLayoutAnimator.setListener(new EMailService() {
                                public void onAnimationEnd(Animator animator) {
                                    final float duration = animator.getDuration();
                                    if (duration == 302) {
                                        FragmentManager fragmentManager = getSupportFragmentManager();
                                        getSupportFragmentManager().beginTransaction()
                                                .remove(fragmentManager.findFragmentByTag("ccBcc"))
                                                .commitNow();
                                        ccBccShown = false;
                                    } else
                                        ccBccShown = true;
                                    System.out.println("im here");
                                    addCcBcc.setClickable(true);
                                }
                            });
                        }
                        subjectContentLayoutAnimator
                                .translationY(ccBccView.getLayoutParams().height)
                                .setDuration(301)
                                .start();
                    } else {
                        final View subjectContentLayout=findViewById(R.id.email_message_composing_subject_content_layout);
                        subjectContentLayout.animate()
                                .translationY(0)
                                .setDuration(302)
                                .start();
                    }
                } else if (viewId == attachmentIcon.getId()) {
                    if (!attachmentMenuShown) {
                        AttachmentMenu attachmentMenu = new AttachmentMenu(EMailMessageComposing.this,
                                attachmentMenuLayout,
                                attachmentMenuBackground);
                        attachmentMenuShown = true;
                        getSupportFragmentManager().beginTransaction()
                                .add(attachmentMenuLayout.getId(), attachmentMenu, "attachment menu")
                                .commit();
                    } else {
                        attachmentMenuShown = false;
                        FragmentManager fragmentManager = getSupportFragmentManager();
                        Fragment attachmentMenu = fragmentManager.findFragmentByTag("attachment menu");
                        if (attachmentMenu != null) {
                            fragmentManager.beginTransaction()
                                    .remove(attachmentMenu)
                                    .commit();
                        } else {
                            attachmentMenuShown = false;
                            attachmentIcon.performClick();
                        }
                    }
                } else if (viewId == send.getId()) {
                    final View currentFocus = getCurrentFocus();
                    if (currentFocus != null) {
                        InputMethodManager keyboard = getApplicationContext().getSystemService(InputMethodManager.class);
                        keyboard.hideSoftInputFromWindow(currentFocus.getWindowToken(), 0);
                        currentFocus.clearFocus();
                    }
                    final int recipientsLayoutViewsCount = toLayout.getChildCount();
                    if (recipientsLayoutViewsCount == 1) {
                        if (recipientsLayoutClickable.getVisibility()==GONE)
                            recipientsLayoutClickable.setVisibility(VISIBLE);
                        if (toLayoutEnter !=null) {
                            final String enterEMailAddress = getString(R.string.enter_email_address);
                            if (toLayoutEnter.enter.getText().toString().isEmpty()) {
                                int red = getColor(R.color.red);
                                toLayoutEnter.enter.setTextColor(red);
                                toLayoutEnter.enter.setText(enterEMailAddress);
                                return;
                            } else if (!toLayoutEnter.enter.getText().toString().equals(enterEMailAddress)) {
                                final HashMap<String, Object> recipientsLayoutData=getRecipientsLayoutData();
                                makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"),
                                                                        (String) recipientsLayoutData.get("type"));
                            } else {
                                send.setClickable(false);
                                ValueAnimator toLayoutOriginAnimator = ValueAnimator.ofFloat(0, 5).setDuration(200);
                                final int red = getColor(R.color.red);
                                toLayoutOriginAnimator.addUpdateListener(new EMailService() {
                                    public void onAnimationUpdate(ValueAnimator animator) {
                                        toLayoutEnter.enter.setShadowLayer((float) animator.getAnimatedValue(), 1, 1, red);
                                    }
                                });
                                toLayoutOriginAnimator.addListener(new EMailService() {
                                    public void onAnimationEnd(Animator animator) {
                                        toLayoutOriginAnimator.setFloatValues(5, 0);
                                        toLayoutOriginAnimator.removeAllListeners();
                                        toLayoutOriginAnimator.addListener(new EMailService() {
                                            public void onAnimationEnd(Animator animator) {
                                                send.setClickable(true);
                                            }
                                        });
                                        toLayoutOriginAnimator.start();
                                    }
                                });
                                toLayoutOriginAnimator.start();
                                return;
                            }
                        }
                    }
                    boolean canSend = true;
                    for (Map.Entry<LayoutPart, String> recipientTypeAndLayoutPart: recipientsLayoutParts.entrySet()) {
                        LayoutPart recipientsLayoutPart=recipientTypeAndLayoutPart.getKey();
                        if (!recipientsLayoutPart.eMailAddressValid) {
                            canSend = false;
                            break;
                        }
                    }
                    if (!canSend)
                        return;
                    if (content.getText().toString().isEmpty()) {
                        final ConfirmingSendingEmptyMessage confirmingSendingEmptyMessage = new ConfirmingSendingEmptyMessage
                                (EMailMessageComposing.this);
                        popUpWindowLayout.setVisibility(VISIBLE);
                        getSupportFragmentManager().beginTransaction()
                                .add(popUpWindowLayout.getId(), confirmingSendingEmptyMessage)
                                .commitNow();
                        if (confirmingSendingEmptyMessageClickListener == null) {
                            confirmingSendingEmptyMessageClickListener = new EMailService() {
                                public void onClick(View view) {
                                    final int viewId = view.getId();
                                    getSupportFragmentManager().beginTransaction()
                                            .remove(confirmingSendingEmptyMessage)
                                            .commitNow();
                                    if (viewId == confirmingSendingEmptyMessage.yes.getId())
                                        sendEMailMessage(recipientsLayoutParts, subject, content, attachments);
                                }
                            };
                        }
                        confirmingSendingEmptyMessage.yes.setOnClickListener(confirmingSendingEmptyMessageClickListener);
                        confirmingSendingEmptyMessage.no.setOnClickListener(confirmingSendingEmptyMessageClickListener);
                    } else
                        EMailService.sendEMailMessage(recipientsLayoutParts, subject, content, attachments);
                } else if (viewId == recipientsLayoutClickable.getId()) {
                    final View currentFocus = getCurrentFocus();
                    if (currentFocus != null) {
                        if (subjectLayoutClickable.getVisibility()==GONE)
                            subjectLayoutClickable.setVisibility(VISIBLE);
                        else
                            contentLayoutClickable.setVisibility(VISIBLE);
                        currentFocus.clearFocus();
                    }
                    recipientsLayoutClickable.setVisibility(GONE);
                    subject.setFocusable(false);
                    content.setFocusable(false);
                    if (toLayoutEnter !=null) {
                        final String toLayoutOriginText = toLayoutEnter.enter.getText().toString();
                        if (!toLayoutOriginText.isEmpty()) {
                            toLayoutEnter.enter.setText("");
                            int black = getColor(R.color.black);
                            toLayoutEnter.enter.setTextColor(black);
                        }
                        toLayoutEnter.enter.requestFocus();
                        InputMethodManager keyboard=getApplicationContext().getSystemService(InputMethodManager.class);
                        keyboard.showSoftInput(toLayoutEnter.enter, InputMethodManager.SHOW_FORCED);
                    } else {
                        FrameLayout toLayoutEnterLayout = new FrameLayout(EMailMessageComposing.this);
                        toLayoutEnterLayout.setId(View.generateViewId());
                        toLayout.addView(toLayoutEnterLayout, 0);
                        toLayoutEnter = new RecipientsLayoutEnter(toLayoutEnterLayout, recipientsLayoutTextChangedListener, true);
                        System.out.println(toLayoutEnterLayout);
                        getSupportFragmentManager().beginTransaction()
                                .add(toLayoutEnterLayout.getId(), toLayoutEnter)
                                .commitNow();
                    }
                } else {
                    final View previousFocus = getCurrentFocus();
                    boolean recipientsLayoutIsLastFocus = false;
                    if (previousFocus != null) {
                        if (recipientsLayoutClickable.getVisibility()==GONE)
                            recipientsLayoutClickable.setVisibility(VISIBLE);
                        else if (subjectLayoutClickable.getVisibility()==GONE)
                            subjectLayoutClickable.setVisibility(VISIBLE);
                        else
                            contentLayoutClickable.setVisibility(VISIBLE);
                        previousFocus.clearFocus();
                        final int currentFocusId = previousFocus.getId();
                        if (currentFocusId != subject.getId() && currentFocusId != content.getId())
                            recipientsLayoutIsLastFocus = true;
                    }
                    if (recipientsLayoutIsLastFocus) {
                        final HashMap<String, Object> recipientsLayoutData=getRecipientsLayoutData();
                        final String recipientsLayoutEnterText = toLayoutEnter.enter.getText().toString();
                        if (modeEditLayoutPartOn) {
                            modeEditLayoutPartOn = false;
                            if (!recipientsLayoutEnterText.isEmpty())
                                makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"),
                                                                        (String) recipientsLayoutData.get("type"));
                            else
                                removeRecipientsLayoutEnter((LinearLayout) recipientsLayoutData.get("layout"),
                                                            (RecipientsLayoutEnter) recipientsLayoutData.get("enter"));
                        } else {
                            if (!recipientsLayoutEnterText.isEmpty()) {
                                final String enterEMailAddress = getString(R.string.enter_email_address);
                                if (!recipientsLayoutEnterText.equals(enterEMailAddress)) {
                                    makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"),
                                                                            (String) recipientsLayoutData.get("type"));
                                }
                            } else {
                                final int toLayoutViewsCount = toLayout.getChildCount();
                                if (toLayoutViewsCount > 1)
                                    removeRecipientsLayoutEnter((LinearLayout) recipientsLayoutData.get("layout"),
                                                                (RecipientsLayoutEnter) recipientsLayoutData.get("enter"));
                            }
                        }
                    }
                    final View viewToShowKeyboard;
                    if (viewId == contentLayoutClickable.getId()) {
                        contentLayoutClickable.setVisibility(GONE);
                        subject.setFocusable(false);
                        content.setFocusableInTouchMode(true);
                        content.setFocusable(true);
                        content.requestFocus();
                        viewToShowKeyboard = content;
                    } else {
                        subjectLayoutClickable.setVisibility(GONE);
                        content.setFocusable(false);
                        subject.setFocusableInTouchMode(true);
                        subject.setFocusable(true);
                        subject.requestFocus();
                        viewToShowKeyboard = subject;
                    }
                    InputMethodManager keyboard = getApplicationContext().getSystemService(InputMethodManager.class);
                    keyboard.showSoftInput(viewToShowKeyboard, InputMethodManager.SHOW_FORCED);
                }
            }
        };
        back.setOnClickListener(eMailMessageComposingClickListener);
        addCcBcc.setOnClickListener(eMailMessageComposingClickListener);
        attachmentIcon.setOnClickListener(eMailMessageComposingClickListener);
        send.setOnClickListener(eMailMessageComposingClickListener);
        recipientsLayoutClickable.setOnClickListener(eMailMessageComposingClickListener);
        subjectLayoutClickable.setOnClickListener(eMailMessageComposingClickListener);
        contentLayoutClickable.setOnClickListener(eMailMessageComposingClickListener);
        recipientsLayoutClickable.bringToFront();
        subjectLayoutClickable.bringToFront();
        shadow = findViewById(R.id.email_message_composing_shadow);
        shadow.bringToFront();
        Drawable attachmentLayoutBackground = ContextCompat.getDrawable(this, R.drawable.background_attachment_layout);
        resultLauncher = registerForActivityResult(new ActivityResultContracts.GetContent(),
                (ActivityResultCallback<Uri>) (uri) -> {
                    InputMethodManager keyboard = getApplicationContext().getSystemService(InputMethodManager.class);
                    keyboard.showSoftInput(content, 0);
                    Cursor cursor = getContentResolver().query(uri, null, null, null, null);
                    cursor.moveToFirst();
                    String contentType = cursor.getString(cursor.getColumnIndex(MediaStore.Files.FileColumns.MIME_TYPE));
                    final AttachmentLayout attachmentLayout;
                    final Drawable icon;
                    if (contentType.startsWith("image/")) {
                        attachmentLayout = findViewById(R.id.email_message_composing_attachment_image_layout);
                        Drawable imageIcon = ContextCompat.getDrawable(EMailMessageComposing.this, R.drawable.attachment_image);
                        icon = imageIcon;
                    } else if (contentType.startsWith("application/")) {
                        attachmentLayout = findViewById(R.id.email_message_composing_attachment_document_layout);
                        Drawable documentIcon = ContextCompat.getDrawable(EMailMessageComposing.this, R.drawable.attachment_document);
                        icon = documentIcon;
                    } else {
                        attachmentLayout = findViewById(R.id.email_message_composing_attachment_audio_layout);
                        Drawable audioIcon = ContextCompat.getDrawable(EMailMessageComposing.this, R.drawable.attachment_audio);
                        icon = audioIcon;
                    }
                    final View attachmentLayoutParent = (View) attachmentLayout.getParent();
                    if (attachmentLayoutParent.getBackground() == null)
                        attachmentLayoutParent.setBackground(attachmentLayoutBackground);
                    EnteringFileName enteringFileName = new EnteringFileName(EMailMessageComposing.this, popUpWindowLayout);
                    Attachment attachment = new Attachment(EMailMessageComposing.this, icon);
                    enteringFileName.setAttachmentToEnterFileName(attachment);
                    View eMailMessageComposingCurrentFocus = getCurrentFocus();
                    if (eMailMessageComposingCurrentFocus != null)
                        eMailMessageComposingCurrentFocus.clearFocus();
                    popUpWindowLayout.setVisibility(VISIBLE);
                    getSupportFragmentManager().beginTransaction()
                            .add(attachmentLayout.getId(), attachment)
                            .add(popUpWindowLayout.getId(), enteringFileName)
                            .commitNow();
                    if (!hasAttachments) {
                        hasAttachments = true;
                        contentLayoutClickable.setVisibility(GONE);
                        contentLayoutClickable=findViewById(R.id.email_message_composing_content_layout_clickable_text);
                        contentLayoutClickable.setOnClickListener(eMailMessageComposingClickListener);
                        contentLayoutClickable.bringToFront();
                    }
                    attachment.content = uri;
                    attachment.contentType = contentType;
                    if (attachments == null)
                        attachments = new ArrayList<>();
                    attachments.add(attachment);
                });
    }

    public void deleteToLayoutPart(LayoutPart layoutPart) {
        View layoutPartFrame = (View) layoutPart.getView().getParent();
        getSupportFragmentManager().beginTransaction()
                .remove(layoutPart)
                .commitNow();
        toLayout.removeView(layoutPartFrame);
        recipientsLayoutParts.remove(layoutPart, recipientsLayoutParts.get(layoutPart));
    }

    public void setModeEditLayoutPartOn(LayoutPart recipientsLayoutPart) {
        HashMap<String, Object> recipientsLayoutData=getRecipientsLayoutData();
        if (!modeEditLayoutPartOn) {
            modeEditLayoutPartOn = true;
            removeRecipientsLayoutEnter((LinearLayout) recipientsLayoutData.get("layout"), (RecipientsLayoutEnter) recipientsLayoutData.get("enter"));
        } else
            makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"), (String) recipientsLayoutData.get("type"));
        editRecipientsLayoutPart(recipientsLayoutPart);
    }

    public void editRecipientsLayoutPart(LayoutPart recipientsLayoutPart) {
        FrameLayout recipientsLayoutPartFrame = (FrameLayout) recipientsLayoutPart.getView().getParent();
        RecipientsLayoutEnter recipientsLayoutEnter = new RecipientsLayoutEnter(recipientsLayoutPartFrame,
                                                                                recipientsLayoutTextChangedListener,
                                                                                true);
        final String eMailAddress=recipientsLayoutPart.eMailAddress;
        recipientsLayoutEnter.setEMailAddress(eMailAddress);
        recipientsLayoutPart.getView().setAlpha(0);
        getSupportFragmentManager().beginTransaction()
                .replace(recipientsLayoutPartFrame.getId(), toLayoutEnter)
                .commit();
    }

    public void makeToLayoutPartFromRecipientsLayoutEnter(RecipientsLayoutEnter recipientsLayoutEnter, String recipientType) {
        final String recipientsLayoutEnterText= recipientsLayoutEnter.enter.getText().toString();
        final boolean toLayoutEnterTextHasEndSpace=recipientsLayoutEnterText.charAt(recipientsLayoutEnterText.length()-1)==' ';
        final String eMailAddress;
        if (toLayoutEnterTextHasEndSpace)
            eMailAddress = getEMailAddressWithNoSpace(recipientsLayoutEnter.enter.getText().toString());
        else
            eMailAddress = recipientsLayoutEnterText;
        LayoutPart toLayoutPart = getLayoutPart(eMailAddress, recipientType);
        recipientsLayoutEnter.getView().setAlpha(0);
        getSupportFragmentManager().beginTransaction()
                .replace(recipientsLayoutEnter.parent.getId(), toLayoutPart)
                .commitNow();
    }

    public void removeRecipientsLayoutEnter(LinearLayout recipientsLayout, RecipientsLayoutEnter recipientsLayoutEnter) {
        getSupportFragmentManager().beginTransaction()
                .remove(recipientsLayoutEnter)
                .commitNow();
        recipientsLayout.removeView(recipientsLayoutEnter.parent);
    }

    public void addToLayoutPart(LinearLayout recipientsLayout, String recipientType, String eMailAddress, int count) {
        FrameLayout recipientsLayoutPartFrame = new FrameLayout(this);
        recipientsLayout.addView(recipientsLayoutPartFrame, count);
        recipientsLayoutPartFrame.setId(View.generateViewId());
        getSupportFragmentManager().beginTransaction()
                .add(recipientsLayoutPartFrame.getId(), getLayoutPart(eMailAddress, recipientType))
                .commit();
    }

    public LayoutPart getLayoutPart(String eMailAddress, String type) {
        final LayoutPart recipientsLayoutPart = new LayoutPart();
        if (EMailService.eMailAddressValid(eMailAddress))
            recipientsLayoutPart.setLayoutPartData(eMailAddress, true, false);
        else
            recipientsLayoutPart.setLayoutPartData(eMailAddress, false, false);
        if (recipientsLayoutParts == null)
            recipientsLayoutParts = new HashMap<>();
        recipientsLayoutParts.put(recipientsLayoutPart, type);
        return recipientsLayoutPart;
    }

    public String getEMailAddressWithNoSpace(String eMailAddress) {
        String eMailAddressWithNoSpace = new StringBuilder(eMailAddress)
                .deleteCharAt(eMailAddress.length() - 1)
                .toString();
        return eMailAddressWithNoSpace;
    }

    public void changeFileName(Attachment attachment) {
        View popUpWindowLayout = findViewById(R.id.email_message_composing_pop_up_window_layout);
        EnteringFileName enteringFileName = new EnteringFileName(this, popUpWindowLayout);
        enteringFileName.changingFileName = true;
        enteringFileName.attachmentToEnterFileName = attachment;
        popUpWindowLayout.setVisibility(VISIBLE);
        getSupportFragmentManager().beginTransaction()
                .add(enteringFileName.parent.getId(), enteringFileName)
                .commitNow();
    }


    public Animation createPopUpWindowAnimation(boolean enter) {
        final View popUpWindowLayout = findViewById(R.id.email_message_composing_pop_up_window_layout);
        final int animationId;
        if (enter)
            animationId = R.anim.fade_from_invisible_to_visible;
        else
            animationId = R.anim.fade_from_visible_to_invisible;
        final Animation animation = AnimationUtils.loadAnimation(this, animationId);
        animation.setAnimationListener(new EMailService() {
            public void onAnimationStart(Animation animation) {
                final float alphaTo;
                if (enter) {
                    shadow.setVisibility(VISIBLE);
                    alphaTo = 1;
                } else
                    alphaTo = 0;
                shadow.animate()
                        .alpha(alphaTo)
                        .setDuration(150)
                        .start();
            }

            public void onAnimationEnd(Animation animation) {
                if (!enter) {
                    shadow.setVisibility(GONE);
                    popUpWindowLayout.postDelayed((Runnable) () -> {
                        popUpWindowLayout.setVisibility(GONE);
                    }, 100);
                }
            }
        });
        return animation;
    }

    public HashMap<String, Object> getRecipientsLayoutData() {
        final HashMap<String, Object> recipientsLayoutData = new HashMap<>();
        FragmentManager fragmentManager = getSupportFragmentManager();
        if (fragmentManager.findFragmentByTag("ccBcc") == null) {
            LinearLayout toLayout = findViewById(R.id.email_message_composing_to_layout);
            recipientsLayoutData.put("layout", toLayout);
            Fragment toLayoutEnter = fragmentManager.findFragmentByTag("To");
            recipientsLayoutData.put("enter", toLayoutEnter);
            recipientsLayoutData.put("type", "To");
        } else {
            final int currentRecipientsLayoutId = ((View) getCurrentFocus().getParent().getParent()).getId();
            if (currentRecipientsLayoutId == R.id.email_message_composing_bcc_layout) {
                LinearLayout bccLayout = findViewById(R.id.email_message_composing_bcc_layout);
                recipientsLayoutData.put("layout", bccLayout);
                Fragment bccLayoutEnter = fragmentManager.findFragmentByTag("Bcc");
                recipientsLayoutData.put("enter", bccLayoutEnter);
                recipientsLayoutData.put("type", "Bcc");
            } else {
                LinearLayout ccLayout = findViewById(R.id.email_message_composing_cc_layout);
                recipientsLayoutData.put("layout", ccLayout);
                Fragment ccLayoutEnter = fragmentManager.findFragmentByTag("Cc");
                recipientsLayoutData.put("enter", ccLayoutEnter);
                recipientsLayoutData.put("type", "Cc");
            }
        }
        return recipientsLayoutData;
    }

    public void onBackPressed() {
        final View currentFocus = getCurrentFocus();
        if (currentFocus != null) {
            currentFocus.clearFocus();
            return;
        }
        final HashMap<String, Object> recipientsLayoutData=getRecipientsLayoutData();
        if (modeEditLayoutPartOn) {
            String recipientsLayoutEnterText = toLayoutEnter.enter.getText().toString();
            if (recipientsLayoutEnterText.isEmpty()) {
                final int recipientsLayoutViewsCount= toLayout.getChildCount();
                if (recipientsLayoutViewsCount!=1)
                    removeRecipientsLayoutEnter((LinearLayout) recipientsLayoutData.get("layout"),
                                                (RecipientsLayoutEnter) recipientsLayoutData.get("enter"));
            }
            else
                makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"),
                                                        (String) recipientsLayoutData.get("type"));
            View toLayoutClickable = findViewById(R.id.email_message_composing_recipients_layout_clickable);
            toLayoutClickable.setVisibility(VISIBLE);
            modeEditLayoutPartOn = false;
            return;
        }
        final boolean toLayoutEnterIsFirstView= toLayoutEnter !=null;
        if (toLayoutEnterIsFirstView) {
            final int toLayoutViewsCount = toLayout.getChildCount();
            final String toLayoutEnterText = toLayoutEnter.enter.getText().toString();
            if (toLayoutViewsCount == 1) {
                if (!toLayoutEnterText.isEmpty()) {
                    makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"),
                                                            (String) recipientsLayoutData.get("type"));
                    View toLayoutClickable = findViewById(R.id.email_message_composing_recipients_layout_clickable);
                    toLayoutClickable.setVisibility(VISIBLE);
                    return;
                }
            } else {
                if (toLayoutEnterText.isEmpty())
                    removeRecipientsLayoutEnter((LinearLayout) recipientsLayoutData.get("layout"),
                                                (RecipientsLayoutEnter) recipientsLayoutData.get("enter"));
                else
                    makeToLayoutPartFromRecipientsLayoutEnter((RecipientsLayoutEnter) recipientsLayoutData.get("enter"),
                            (String) recipientsLayoutData.get("type"));
                View toLayoutClickable = findViewById(R.id.email_message_composing_recipients_layout_clickable);
                toLayoutClickable.setVisibility(VISIBLE);
                return;
            }
        }
        FragmentManager fragmentManager=getSupportFragmentManager();
        Fragment attachmentMenu=fragmentManager.findFragmentByTag("attachment menu");
        if (attachmentMenu!=null) {
            fragmentManager.beginTransaction()
                    .remove(attachmentMenu)
                    .commit();
            return;
        }
        Intent intent = new Intent(this, MenuMain.class);
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
        startActivity(intent);
    }

    public static class RecipientsLayout  {
        LinearLayout layout;
        RecipientsLayoutEnter enter;

        public RecipientsLayout(LinearLayout layout, RecipientsLayoutEnter enter) {
            this.layout=layout;
            this.enter=enter;
        }
    }

    public static class RecipientsLayoutEnter extends Fragment {
        View parent;
        EMailService toLayoutTextChangedListener;
        private String eMailAddress;
        EditText enter;
        boolean needKeyboard;

        public RecipientsLayoutEnter(View parent, EMailService toLayoutTextChangedListener, boolean needKeyboard) {
            this.parent=parent;
            this.toLayoutTextChangedListener=toLayoutTextChangedListener;
            this.needKeyboard=needKeyboard;
        }

        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.recipients_layout_enter, container, false);
        }

        public void onViewCreated(View view, Bundle savedInstanceState) {
            super.onStart();
            enter = view.findViewById(R.id.enter);
            enter.setText(eMailAddress);
            if (needKeyboard) {
                enter.requestFocus();
                EMailMessageComposing eMailMessageComposing = (EMailMessageComposing) EMailService.getActivityCurrent();
                InputMethodManager keyboard = eMailMessageComposing.getApplicationContext().getSystemService(InputMethodManager.class);
                keyboard.showSoftInput (enter, InputMethodManager.SHOW_FORCED);
            }
            enter.addTextChangedListener(toLayoutTextChangedListener);
        }

        public void setEMailAddress(String eMailAddress) {
            this.eMailAddress=eMailAddress;
        }
    }

    public static class AttachmentMenu extends Fragment {
        EMailMessageComposing eMailMessageComposing;
        Drawable background;
        View parent;

        public AttachmentMenu(EMailMessageComposing eMailMessageComposing, View parent, Drawable background) {
            this.eMailMessageComposing = eMailMessageComposing;
            this.parent = parent;
            this.background = background;
        }

        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.email_message_composing_attachment_menu, container, false);
        }

        public void onViewCreated(View view, Bundle savedInstanceState) {
            View document = view.findViewById(R.id.email_message_composing_attachment_menu_document_layout_clickable);
            View image = view.findViewById(R.id.email_message_composing_attachment_menu_image_layout_clickable);
            EMailService attachmentMenuClickListener = new EMailService() {
                public void onClick(View view) {
                    final int viewId = view.getId();
                    if (viewId == document.getId())
                        eMailMessageComposing.resultLauncher.launch("application/*");
                    else if (viewId == image.getId())
                        eMailMessageComposing.resultLauncher.launch("image/*");
                    else
                        eMailMessageComposing.resultLauncher.launch("audio/*");
                    final View eMailMessageComposingCurrentFocus = eMailMessageComposing.getCurrentFocus();
                    if (eMailMessageComposingCurrentFocus!=null) {
                        InputMethodManager keyboard = eMailMessageComposing.getApplicationContext().getSystemService(InputMethodManager.class);
                        keyboard.hideSoftInputFromWindow(eMailMessageComposingCurrentFocus.getWindowToken(), 0);
                    }
                    eMailMessageComposing.getSupportFragmentManager().beginTransaction()
                            .remove(AttachmentMenu.this)
                            .commitNow();
                }
            };
            document.setOnClickListener(attachmentMenuClickListener);
            image.setOnClickListener(attachmentMenuClickListener);
            View audio = view.findViewById(R.id.email_message_composing_attachment_menu_audio_layout_clickable);
            audio.setOnClickListener(attachmentMenuClickListener);
        }

        public Animation onCreateAnimation(int anim, boolean enter, int animNext) {
            final int animationId;
            if (enter)
                animationId = R.anim.slide_top_bottom_fade_invisible_visible;
            else
                animationId = R.anim.slide_bottom_top_fade_visible_invisible;
            final Animation animation = AnimationUtils.loadAnimation(eMailMessageComposing, animationId);
            animation.setAnimationListener(new EMailService() {
                public void onAnimationStart(Animation animation) {
                    if (!enter)
                        parent.setBackground(null);
                }

                public void onAnimationEnd(Animation animation) {
                    if (enter)
                        parent.setBackground(background);
                }
            });
            return animation;
        }
    }

    public static class Attachment extends Fragment  {
        EMailMessageComposing eMailMessageComposing;
        Drawable icon;
        Uri content;
        String contentType;
        TextView fileName;
        ImageView addFileName;
        GestureDetectorCompat gestureDetector;

        public Attachment(EMailMessageComposing eMailMessageComposing, Drawable icon) {
            this.eMailMessageComposing = eMailMessageComposing;
            this.icon=icon;
        }

        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.email_message_composing_attachment, container, false);
        }

        public void onViewCreated(View view, Bundle savedInstanceState) {
            ImageView icon = view.findViewById(R.id.email_message_composing_attachment);
            icon.setImageDrawable(this.icon);
            icon.setOnTouchListener(new View.OnTouchListener() {
                public boolean onTouch(View view, MotionEvent event) {
                    return gestureDetector.onTouchEvent(event);
                }
            });
            fileName = view.findViewById(R.id.email_message_composing_attachment_file_name);
            addFileName=view.findViewById(R.id.email_message_composing_attachment_add_file_name);
            View fileNameLayoutClickable = view.findViewById(R.id.email_message_composing_attachment_file_name_layout_clickable);
            fileNameLayoutClickable.setOnClickListener(new EMailService() {
                public void onClick(View view) {
                    eMailMessageComposing.changeFileName(Attachment.this);
                }
            });
            gestureDetector = new GestureDetectorCompat(getContext(), new GestureDetector.SimpleOnGestureListener() {

                public boolean onSingleTapConfirmed(MotionEvent event) {
                    System.out.println("hello");
                    Intent intent = new Intent();
                    return true;
                }

                public boolean onFling(MotionEvent firstEvent, MotionEvent secondEvent, float velocityX, float velocityY) {
                    if (velocityY <= -100) {
                        AccelerateInterpolator accelerateInterpolator = new AccelerateInterpolator();
                        view.animate()
                                .translationY(-100)
                                .setInterpolator(accelerateInterpolator)
                                .setDuration(300)
                                .start();
                        view.animate()
                                .alpha(0)
                                .setInterpolator(accelerateInterpolator)
                                .setDuration(301)
                                .setListener(new EMailService() {
                                    public void onAnimationEnd(Animator animator) {
                                        if (view.getAlpha() == 0) {
                                            eMailMessageComposing.attachments.remove(Attachment.this);
                                            final AttachmentLayout attachmentsLayout = (AttachmentLayout) view.getParent();
                                            final int attachmentsLayoutViewsCount = attachmentsLayout.getChildCount();
                                            eMailMessageComposing.getSupportFragmentManager().beginTransaction()
                                                    .remove(Attachment.this)
                                                    .commitNow();
                                            if (attachmentsLayoutViewsCount != 1) {
                                                View plugView=new View(eMailMessageComposing);
                                                plugView.setLayoutParams(view.getLayoutParams());
                                                attachmentsLayout.addView(plugView);
                                                final int removedAttachmentIndex=attachmentsLayout.indexOfChild(view);
                                                final Animation attachmentAnimation=AnimationUtils.loadAnimation(eMailMessageComposing,
                                                        R.anim.slide_right_left);
                                                for (int index=removedAttachmentIndex+1; index<attachmentsLayoutViewsCount; index++) {
                                                    View attachment=attachmentsLayout.getChildAt(index);
                                                    if (index==attachmentsLayoutViewsCount-1) {
                                                        attachmentAnimation.setAnimationListener(new EMailService() {
                                                            public void onAnimationEnd(Animation animation) {
                                                                attachmentsLayout.removeView(plugView);
                                                            }
                                                        });
                                                    }
                                                    attachment.startAnimation(attachmentAnimation);
                                                }
                                            }
                                        }
                                    }
                                })
                                .start();
                    }
                    return true;
                }
            });
        }
    }

    public static class EnteringFileName extends Fragment {
        EMailMessageComposing eMailMessageComposing;
        Attachment attachmentToEnterFileName;
        EditText enter;
        View parent;
        boolean changingFileName;

        public EnteringFileName(EMailMessageComposing eMailMessageComposing, View parent) {
            this.eMailMessageComposing = eMailMessageComposing;
            this.parent = parent;
        }

        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.email_message_composing_entering_file_name, container, false);
        }

        public void onViewCreated(View view, Bundle savedInstanceState) {
            View eMailMessageComposingCurrentFocus = eMailMessageComposing.getCurrentFocus();
            if (eMailMessageComposingCurrentFocus != null)
                eMailMessageComposingCurrentFocus.clearFocus();
            View ok = view.findViewById(R.id.email_message_composing_entering_file_name_ok_layout_clickable);
            View cancel = view.findViewById(R.id.email_message_composing_entering_file_name_cancel_layout_clickable);
            EMailService enteringFileNameClickListener = new EMailService() {
                public void onClick(View view) {
                    final int viewId = view.getId();
                    if (viewId == ok.getId()) {
                        final String enterText=enter.getText().toString();
                        attachmentToEnterFileName.fileName.setText(enterText);
                        if (enterText.isEmpty()) {
                            if (attachmentToEnterFileName.addFileName.getVisibility()==GONE) {
                                attachmentToEnterFileName.fileName.setVisibility(GONE);
                                attachmentToEnterFileName.addFileName.setVisibility(VISIBLE);
                            }
                        } else {
                            if (attachmentToEnterFileName.fileName.getVisibility() == GONE) {
                                attachmentToEnterFileName.addFileName.setVisibility(GONE);
                                attachmentToEnterFileName.fileName.setVisibility(VISIBLE);
                            }
                        }
                    } else if (!changingFileName) {
                        attachmentToEnterFileName.fileName.setVisibility(GONE);
                        attachmentToEnterFileName.addFileName.setVisibility(VISIBLE);
                    }
                    changingFileName=false;
                    eMailMessageComposing.getSupportFragmentManager().beginTransaction()
                            .remove(EnteringFileName.this)
                            .commit();
                    View eMailMessageComposingCurrentFocus = eMailMessageComposing.getCurrentFocus();
                    if (eMailMessageComposingCurrentFocus != null)
                        eMailMessageComposingCurrentFocus.clearFocus();
                }
            };
            ok.setOnClickListener(enteringFileNameClickListener);
            cancel.setOnClickListener(enteringFileNameClickListener);
            enter = view.findViewById(R.id.email_message_composing_entering_file_name_enter);
        }


        public void onStart() {
            enter.requestFocus();
            enter.postDelayed((Runnable) () -> {
                InputMethodManager keyboard = eMailMessageComposing.getApplicationContext().getSystemService(InputMethodManager.class);
                keyboard.showSoftInput(enter, 0);
            }, 100);
            if (changingFileName) {
                enter.setText(attachmentToEnterFileName.fileName.getText().toString());
            }
            super.onStart();
        }

        public void setAttachmentToEnterFileName(Attachment attachmentIconToEnterFileName) {
            this.attachmentToEnterFileName = new WeakReference<>(attachmentIconToEnterFileName).get();
        }

        public Animation onCreateAnimation(int anim, boolean enter, int animNext) {
            return eMailMessageComposing.createPopUpWindowAnimation(enter);
        }
    }

    public static class ConfirmingSendingEmptyMessage extends Fragment {
        EMailMessageComposing eMailMessageComposing;
        View yes;
        View no;

        public ConfirmingSendingEmptyMessage(EMailMessageComposing eMailMessageComposing) {
            this.eMailMessageComposing = eMailMessageComposing;
        }

        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.email_message_composing_confirming_sending_empty_message, container, false);
        }

        public void onViewCreated(View view, Bundle savedInstanceState) {
            yes = view.findViewById(R.id.email_message_composing_confirming_sending_empty_message_yes);
            no = view.findViewById(R.id.email_message_composing_confirming_sending_empty_message_no);
        }

        public Animation onCreateAnimation(int anim, boolean enter, int animNext) {
            return eMailMessageComposing.createPopUpWindowAnimation(enter);
        }
    }

    public static class EMailMessageSending extends Fragment {
        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.email_message_sending, container, false);
        }
    }

    public static class CcBcc extends Fragment {
        public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
            return inflater.inflate(R.layout.cc_bcc, container, false);
        }
    }
}
