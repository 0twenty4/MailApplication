package com.example.mailapplication;

import android.animation.Animator;
import android.animation.ValueAnimator;
import android.content.ContentResolver;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;

import androidx.appcompat.app.AppCompatActivity;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import android.text.Editable;
import android.text.TextWatcher;
import android.util.Base64;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.Animation;
import android.webkit.WebResourceRequest;
import android.webkit.WebResourceResponse;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;
import static android.view.View.GONE;
import static android.view.View.VISIBLE;
import java.io.BufferedInputStream;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import javax.activation.CommandMap;
import javax.activation.DataHandler;
import javax.activation.MailcapCommandMap;
import javax.mail.Address;
import javax.mail.Flags;
import javax.mail.Folder;
import javax.mail.Message;
import javax.mail.Multipart;
import javax.mail.Part;
import javax.mail.Session;
import javax.mail.Store;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;
import javax.mail.util.ByteArrayDataSource;

import java.io.InputStream;

public class EMailService implements Animation.AnimationListener, ValueAnimator.AnimatorListener, ValueAnimator.AnimatorUpdateListener,
                                    View.OnClickListener, View.OnLongClickListener, View.OnFocusChangeListener,
                                    TextWatcher,
                                    ViewGroup.OnHierarchyChangeListener {
    private static String currentUserEMailAddress;
    private static String currentUserPassword;
    private static AppCompatActivity activityCurrent;
    private static FragmentManager activityCurrentFragmentManager;
    private static int activityCurrentFragmentLoadingLayoutId;
    private static final Session session;
    private static Transport transport;
    private static Store store;
    private static Folder folder;
    private static List<Message> eMailMessagesAll;
    private static final ArrayList<EMailMessage> eMailMessagesLoadedCurrent = new ArrayList<>();
    private static final ArrayList<EMailMessage> eMailMessagesDisplayed = new ArrayList<>();
    private static int eMailMessagesLoadedAllAmount;
    private static final int LOAD_AMOUNT = 20;
    private static final int DISPLAY_AMOUNT = 15;
    private static EMailMessage firstEMailMessageDisplayed;
    private static Fragment fragmentLoadingCurrent;
    private static Fragment loadMore;
    private static ConfirmingDeletingMainMenu mainMenuConfirmingDeleting;
    private static final String MULTIPART = "multipart/*";
    private static final String TEXT_PLAIN = "text/plain";
    private static final String TEXT_HTML = "text/html";
    private static final String MESSAGE_RFC822 = "message/rfc822";
    private static final String IMAGE_PNG = "image/png";
    private static final String IMAGE_JPEG= "image/jpeg";
    private static final String IMAGE="image";
    private static final String HTTP="http://";
    private static final String HTTPS="https://";
    private static final String UNKNOWN_CONTENT_TYPE="unknown content type";
    private static boolean eMailMessageCurrentHasContentHtml;
    private static final ExecutorService executor=Executors.newSingleThreadExecutor();
    private static EMailMessage eMailMessageCurrent;
    private static boolean hasDisplayedMessages;
    private static boolean hasLogOut;
    private static boolean modeMainMenuDeleting;
    private static boolean modeMainMenuConfirmingDeleting;
    private static boolean areEMailMessagesDisplayedTicked;
    private static final ArrayList<EMailMessage> eMailMessagesDisplayedTicked=new ArrayList<>();
    private static int currentMainMenuScrollY;


    static {
        Properties properties = new Properties();
        properties.put("mail.transport.protocol", "smtp");
        properties.put("mail.smtp.host", "smtp.gmail.com");
        properties.put("mail.smtp.port", "587");
        properties.put("mail.smtp.auth", "true");
        properties.put("mail.smtp.starttls.enable", "true");
        properties.put("mail.store.protocol", "imaps");
        properties.put("mail.imaps.host", "imap.gmail.com");
        properties.put("mail.imaps.port", "993");
        properties.put("mail.imaps.auth", "true");
        session = Session.getInstance(properties, null);
        MailcapCommandMap mailApplicationMailcapCommandMap = (MailcapCommandMap) CommandMap.getDefaultCommandMap();
        mailApplicationMailcapCommandMap.addMailcap("text/html;; x-java-content-handler=com.sun.mail.handlers.text_html");
        mailApplicationMailcapCommandMap.addMailcap("text/xml;; x-java-content-handler=com.sun.mail.handlers.text_xml");
        mailApplicationMailcapCommandMap.addMailcap("text/plain;; x-java-content-handler=com.sun.mail.handlers.text_plain");
        mailApplicationMailcapCommandMap.addMailcap("image/*;; x-java-content-handler=com.sum.mail.handlers.image_mixed");
        mailApplicationMailcapCommandMap.addMailcap("multipart/*;; x-java-content-handler=com.sun.mail.handlers.multipart_mixed");
        mailApplicationMailcapCommandMap.addMailcap("message/rfc822;; x-java-content-handler=com.mail.handlers.message_rfc822");
        CommandMap.setDefaultCommandMap(mailApplicationMailcapCommandMap);
    }

    public static String getCurrentUserEMailAddress() {
        return currentUserEMailAddress;
    }

    public static AppCompatActivity getActivityCurrent() {
        return activityCurrent;
    }

    public static int getActivityCurrentFragmentLoadingLayoutId() {
        return activityCurrentFragmentLoadingLayoutId;
    }

    public static boolean hasLogOut() {
        return hasLogOut;
    }

    public static void setCurrentActivity(AppCompatActivity activity, int viewGroup) {
        activityCurrent = activity;
        activityCurrentFragmentLoadingLayoutId = viewGroup;
        activityCurrentFragmentManager=activity.getSupportFragmentManager();
    }

    public static void setModeMainMenuDeleting(boolean isOn) {
        modeMainMenuDeleting =isOn;
        final int viewVisibility;
        if (isOn)
            viewVisibility=VISIBLE;
        else {
            areEMailMessagesDisplayedTicked=false;
            viewVisibility = GONE;
        }
        for (EMailMessage eMailMessage:eMailMessagesDisplayed) {
            ImageView eMailMessageDelete=eMailMessage.getView().findViewById(R.id.email_message_delete);
            eMailMessageDelete.setVisibility(viewVisibility);
            if (!isOn && eMailMessage.ticked) {
                eMailMessage.ticked = false;
                eMailMessagesDisplayedTicked.remove(eMailMessage);
                ImageView eMailMessageTick = eMailMessage.getView().findViewById(R.id.email_message_tick);
                eMailMessageTick.setVisibility(GONE);
                View eMailMessageView = eMailMessage.getView();
                int white = activityCurrent.getColor(R.color.white);
                int grey = activityCurrent.getColor(R.color.bright_grey);
                ValueAnimator eMailMessageViewAnimator = ValueAnimator.ofArgb(grey, white).setDuration(300);
                eMailMessageViewAnimator.addUpdateListener(new EMailService() {
                    public void onAnimationUpdate(ValueAnimator animator) {
                        eMailMessageView.setBackgroundColor((int) animator.getAnimatedValue());
                    }
                });
                eMailMessageViewAnimator.start();
            }
        }
        ImageView mainMenuTick= activityCurrent.findViewById(R.id.main_menu_tick);
        mainMenuTick.setVisibility(viewVisibility);
        ImageView mainMenuDelete= activityCurrent.findViewById(R.id.main_menu_delete);
        mainMenuDelete.setVisibility(viewVisibility);
    }

    public static boolean getModeMainMenuDeleting() {
        return modeMainMenuDeleting;
    }

    public static void setModeMainMenuConfirmingDeletingOn(EMailMessage onlyOneMessageToDelete) {
        if (onlyOneMessageToDelete!=null) {
            setConfirmingDeleting(true, onlyOneMessageToDelete);
        } else {
            int eMailMessagesDisplayedTickedAmount = eMailMessagesDisplayedTicked.size();
            if (eMailMessagesDisplayedTickedAmount > 1)
                setConfirmingDeleting(true, null);
            else {
                EMailMessage onlyOneEMailMessageToDelete = eMailMessagesDisplayedTicked.get(0);
                setConfirmingDeleting(true, onlyOneEMailMessageToDelete);
            }
        }
    }

    public static void setModeMainMenuConfirmingDeletingOff() {
        setConfirmingDeleting(false, null);
    }

    private static void setConfirmingDeleting(boolean isOn, EMailMessage onlyOneEMailMessageToDelete) {
        modeMainMenuConfirmingDeleting = isOn;
        if (mainMenuConfirmingDeleting == null)
            mainMenuConfirmingDeleting = new ConfirmingDeletingMainMenu();
        int eMailMessagesDisplayedTickedAmount=eMailMessagesDisplayedTicked.size();
        final FragmentTransaction currentActivityFragmentTransaction = activityCurrentFragmentManager.beginTransaction();
        final View mainMenuClickLayout= activityCurrent.findViewById(R.id.main_menu_root_click_layout);
        final boolean viewsClickable;
        if (isOn) {
            if (onlyOneEMailMessageToDelete==null) {
                if (eMailMessagesDisplayedTickedAmount>1)
                    mainMenuConfirmingDeleting.setOnlyOneEMailMessageToDelete(null);
                else {
                    EMailMessage eMailMessageToDelete=eMailMessagesDisplayedTicked.get(0);
                    mainMenuConfirmingDeleting.setOnlyOneEMailMessageToDelete(eMailMessageToDelete);
                }
            } else {
                mainMenuConfirmingDeleting.setOnlyOneEMailMessageToDelete(onlyOneEMailMessageToDelete);
            }
            viewsClickable = false;
            int mainMenuConfirmingDeletingLayoutId = R.id.main_menu_confirming_deleting_layout;
            currentActivityFragmentTransaction
                    .add(mainMenuConfirmingDeletingLayoutId, mainMenuConfirmingDeleting)
                    .commit();
            mainMenuClickLayout.setVisibility(VISIBLE);
            mainMenuClickLayout.bringToFront();
        } else {
            viewsClickable = true;
            currentActivityFragmentTransaction
                    .remove(mainMenuConfirmingDeleting)
                    .commit();
            mainMenuClickLayout.setVisibility(GONE);
        }
        int eMailMessagesDisplayedAmount = eMailMessagesDisplayed.size();
        for (int index = 0; index < eMailMessagesDisplayedAmount; index++) {
            EMailMessage eMailMessage = eMailMessagesDisplayed.get(index);
            eMailMessage.setClickable(viewsClickable);
        }
        ViewGroup mainMenuTop= activityCurrent.findViewById(R.id.email_message_open_top);
        int mainMenuTopViewAmount=mainMenuTop.getChildCount();
        for (int index=0; index<mainMenuTopViewAmount; index++) {
            View mainMenuTopView=mainMenuTop.getChildAt(index);
            mainMenuTopView.setClickable(viewsClickable);
        }
    }

    public static boolean getModeMainMenuConfirmingDeleting() {
        return modeMainMenuConfirmingDeleting;
    }

    public static void setEMailMessagesDisplayedTicked(boolean ticked) {
        areEMailMessagesDisplayedTicked=ticked;
        final int white= activityCurrent.getColor(R.color.white);
        final int grey= activityCurrent.getColor(R.color.bright_grey);
        final ValueAnimator eMailMessageViewAnimator;
        if (ticked) {
            ArrayList<EMailMessage> eMailMessagesDisplayedNotTicked = new ArrayList<>();
            for (EMailMessage eMailMessage : eMailMessagesDisplayed) {
                if (!eMailMessage.ticked)
                    eMailMessagesDisplayedNotTicked.add(eMailMessage);
            }
            eMailMessageViewAnimator=ValueAnimator.ofArgb(white, grey).setDuration(300);
            for (EMailMessage eMailMessage:eMailMessagesDisplayedNotTicked) {
                eMailMessage.ticked = true;
                addEMailMessagesDisplayedTicked(eMailMessage);
                View eMailMessageView = eMailMessage.getView();
                ImageView eMailMessageTick = eMailMessageView.findViewById(R.id.email_message_tick);
                eMailMessageTick.setVisibility(VISIBLE);
                eMailMessageViewAnimator.addUpdateListener(new EMailService() {
                    public void onAnimationUpdate(ValueAnimator animator) {
                        eMailMessageView.setBackgroundColor((int) animator.getAnimatedValue());
                    }
                });
            }
            } else {
            eMailMessageViewAnimator=ValueAnimator.ofArgb(grey, white).setDuration(300);
            for (EMailMessage eMailMessage:eMailMessagesDisplayed) {
                eMailMessage.ticked=false;
                removeEMailMessagesDisplayedTicked(eMailMessage);
                View eMailMessageView=eMailMessage.getView();
                ImageView eMailMessageTick=eMailMessageView.findViewById(R.id.email_message_tick);
                eMailMessageTick.setVisibility(GONE);
                eMailMessageViewAnimator.addUpdateListener(new EMailService() {
                    public void onAnimationUpdate(ValueAnimator animator) {
                        eMailMessageView.setBackgroundColor((int) animator.getAnimatedValue());
                    }
                });
            }
        }
        eMailMessageViewAnimator.start();
    }

    public static boolean getAreEMailMessagesDisplayedTicked() {
        return areEMailMessagesDisplayedTicked;
    }

    public static int getEMailMessagesDisplayedTickedAmount() {
        return eMailMessagesDisplayedTicked.size();
    }

    public static void addEMailMessagesDisplayedTicked(EMailMessage eMailMessage) {
        eMailMessagesDisplayedTicked.add(eMailMessage);
    }

    public static void removeEMailMessagesDisplayedTicked(EMailMessage eMailMessage) {
        eMailMessagesDisplayedTicked.remove(eMailMessage);

    }

    public static void deleteMessage(EMailMessage onlyOneEMailMessageToDelete) {
        delete(onlyOneEMailMessageToDelete, null);
    }

    public static void deleteMessages() {
        ArrayList<EMailMessage> eMailMessagesToDelete=new ArrayList<>(eMailMessagesDisplayedTicked);
        delete(null, eMailMessagesToDelete);
    }

    public static void delete(EMailMessage onlyOneEMailMessageToDelete, ArrayList<EMailMessage> eMailMessagesToDelete) {
        setModeMainMenuConfirmingDeletingOff();
        setModeMainMenuDeleting(false);
        fragmentLoadingCurrent = new LoadingProgressBarCircle();
        activityCurrentFragmentManager.beginTransaction()
                .add(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
        removeEMailMessagesLayoutViews();
        removeEMailMessagesDisplayedToEMailMessagesLoaded();
        executor.execute((Runnable) () -> {
            try {
                if (onlyOneEMailMessageToDelete!=null) {
                    Message message = onlyOneEMailMessageToDelete.message;
                    message.setFlag(Flags.Flag.DELETED, true);
                    eMailMessagesLoadedCurrent.remove(onlyOneEMailMessageToDelete);
                    eMailMessagesLoadedAllAmount--;
                } else {
                    for (EMailMessage eMailMessage : eMailMessagesToDelete) {
                        Message message = eMailMessage.message;
                        message.setFlag(Flags.Flag.DELETED, true);
                        eMailMessagesLoadedCurrent.remove(eMailMessage);
                        eMailMessagesLoadedAllAmount--;
                    }
                }
                folder.close(true);
                folder.open(Folder.READ_WRITE);
                Message[] messagesAll=folder.getMessages();
                eMailMessagesAll=Arrays.asList(messagesAll);
                Collections.reverse(eMailMessagesAll);
                int messageCount=eMailMessagesLoadedCurrent.size();
                loadMessages(messageCount);
                System.out.println(messageCount);
                System.out.println(eMailMessagesLoadedCurrent.size());
            } catch (Exception e) {
            }
            activityCurrent.runOnUiThread((Runnable) () -> {
                int eMailMessagesLayout = R.id.main_menu_email_messages_layout;
                TextView noMessages = activityCurrent.findViewById(R.id.no_messages);
                int noMessagesVisibility = noMessages.getVisibility();
                if (canDisplay(eMailMessagesLayout)) {
                    if (noMessagesVisibility == VISIBLE)
                        noMessages.setVisibility(GONE);
                    loadMore = new LoadMore();
                    activityCurrentFragmentManager.beginTransaction()
                            .add(eMailMessagesLayout, loadMore)
                            .commit();
                } else {
                    if (noMessages.getVisibility() == GONE)
                        noMessages.setVisibility(VISIBLE);
                }
                activityCurrentFragmentManager.beginTransaction()
                        .remove(fragmentLoadingCurrent)
                        .commit();
            });
        });
    }

    public static void sendEMailMessage(ArrayList<LayoutPart> eMailMessageTo, TextView eMailMessageSubject, TextView eMailMessageText, ArrayList<EMailMessageComposing.Attachment> attachments) {
        View activityCurrentFragmentLoadingLayout=activityCurrent.findViewById(R.id.email_message_composing_fragment_loading_layout);
        activityCurrentFragmentLoadingLayout.setVisibility(VISIBLE);
        fragmentLoadingCurrent=new EMailMessageSending();
        activityCurrentFragmentManager.beginTransaction()
                .runOnCommit((Runnable) () -> {
                    executor.execute((Runnable) () -> {
                        try {
                            MimeMessage eMailMessage = new MimeMessage(session);
                            eMailMessage.setFrom(currentUserEMailAddress);
                            eMailMessage.setSubject(eMailMessageSubject.getText().toString());
                            MimeMultipart eMailMessageContent=new MimeMultipart();
                            MimeBodyPart eMailMessagePartText=new MimeBodyPart();
                            eMailMessagePartText.setContent(eMailMessageText.getText().toString(), TEXT_HTML);
                            eMailMessageContent.addBodyPart(eMailMessagePartText);
                            if (!attachments.isEmpty()) {
                                final ContentResolver contentResolver=activityCurrent.getContentResolver();
                                for (EMailMessageComposing.Attachment attachment:attachments) {
                                    InputStream contentStream = contentResolver.openInputStream(attachment.content);
                                    ArrayList<Byte> contentBytesList = new ArrayList<>();
                                    do {
                                        contentBytesList.add((byte) contentStream.read());
                                    } while (contentStream.available() > 0);
                                    contentStream.close();
                                    byte[] contentBytesArray = new byte[contentBytesList.size()];
                                    for (int index = 0; index < contentBytesArray.length; index++)
                                        contentBytesArray[index] = contentBytesList.get(index);
                                    MimeBodyPart eMailMessagePartAttachment = new MimeBodyPart();
                                    eMailMessagePartAttachment.setDataHandler(new DataHandler(new ByteArrayDataSource(contentBytesArray, attachment.contentType)));
                                    eMailMessagePartAttachment.setFileName(attachment.fileName.getText().toString());
                                    eMailMessageContent.addBodyPart(eMailMessagePartAttachment);
                                }
                            }
                            final String firstEMailAddress=eMailMessageTo.get(0).eMailAddress;
                            if (eMailMessageTo.size()==1) {
                                eMailMessage.setRecipients(Message.RecipientType.TO, firstEMailAddress);
                            } else {
                                StringBuilder eMailAddresses = new StringBuilder();
                                eMailAddresses.append(firstEMailAddress);
                                if (eMailMessageTo.size() > 1) {
                                    final String comma = ",";
                                    for (int index = 1; index < eMailMessageTo.size(); index++) {
                                        String eMailAddress = eMailMessageTo.get(index).eMailAddress;
                                        eMailAddresses.append(comma).append(eMailAddress);
                                    }
                                }
                                eMailMessage.setRecipients(Message.RecipientType.TO, eMailAddresses.toString());
                            }
                            eMailMessage.setContent(eMailMessageContent);
                            eMailMessage.saveChanges();
                            Transport.send(eMailMessage, currentUserEMailAddress, currentUserPassword);
                            activityCurrent.runOnUiThread((Runnable) () -> {
                                activityCurrent.onBackPressed();
                            });
                        } catch (Exception e) {
                            activityCurrent.runOnUiThread((Runnable) () -> {
                                activityCurrentFragmentManager.beginTransaction()
                                        .runOnCommit((Runnable) () -> {
                                            activityCurrentFragmentLoadingLayout.postDelayed((Runnable) () -> {
                                                activityCurrentFragmentLoadingLayout.setVisibility(GONE);
                                            }, 100);
                                        })
                                        .remove(fragmentLoadingCurrent)
                                        .commit();
                            });
                        }
                    });
                })
                .setCustomAnimations(R.anim.slide_from_right_to_middle, R.anim.slide_from_middle_to_right)
                .add(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
    }

    public static void loadUser(String login, String password) {
        currentUserEMailAddress = login;
        currentUserPassword = password;
    }

    public static boolean fieldEmpty(String field) {
        return field.isEmpty();
    }

    public static boolean eMailAddressValid(String eMailAddress) {
        try {
            InternetAddress internetAddress = new InternetAddress(eMailAddress);
            internetAddress.validate();
            return true;
        } catch (Exception e) {
            return false;
        }
    }

    public static boolean passwordCorrect(String password) {
        boolean passwordCorrect=false;
        if (password.length() >= 8) {
            char[] charactersPasswordString = password.toCharArray();
            ArrayList<Character> symbolsPasswordString = new ArrayList<>();
            for (char character : charactersPasswordString) {
                if (character != ' ') symbolsPasswordString.add(character);
            }
            boolean hasNoSpace = true;
            if (charactersPasswordString.length != symbolsPasswordString.size()) {
                for (int i = 0; i < symbolsPasswordString.size(); i++) {
                    if (charactersPasswordString[i] == ' ') {
                        hasNoSpace = false;
                        break;
                    }
                }
            }
            if (hasNoSpace) {
                boolean hasNumber = false;
                boolean hasLetter = false;
                for (char character : charactersPasswordString) {
                    if (Character.isDigit(character)) {
                        hasNumber = true;
                        if (hasLetter) {
                            break;
                        }
                    } else if (Character.isLetter(character)) {
                        hasLetter = true;
                        if (hasNumber) {
                            passwordCorrect = true;
                            break;
                        }
                    }
                }
            }
        }
        if (passwordCorrect)
            return true;
        else
            return false;
    }

    public static void connectToNetwork() {
        executor.execute((Runnable) () -> {
            try {
                activityCurrent.runOnUiThread((Runnable) () -> {
                            fragmentLoadingCurrent = new Connecting();
                            activityCurrentFragmentManager.beginTransaction()
                                    .setCustomAnimations(R.anim.slide_from_right_to_middle, 0)
                                    .add(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                                    .commit();
                        });
                transport = session.getTransport();
                transport.connect(currentUserEMailAddress, currentUserPassword);
                activityCurrent.runOnUiThread((Runnable) () -> {
                    fragmentLoadingCurrent = new LoadingEMailMessages();
                    activityCurrentFragmentManager.beginTransaction()
                            .replace(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                            .commit();

                });
                getMessages();
                loadMessages(0);
                activityCurrent.runOnUiThread((Runnable) () -> {
                    Intent intent = new Intent(activityCurrent, MenuMain.class);
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
                    activityCurrent.startActivity(intent);
                });
            } catch (Exception e) {
                activityCurrent.runOnUiThread((Runnable) () -> {
                    TextView accountNotExist = activityCurrent.findViewById(R.id.account_not_exist);
                    accountNotExist.setVisibility(VISIBLE);
                    activityCurrentFragmentManager.beginTransaction()
                            .setCustomAnimations(0, R.anim.slide_from_middle_to_right)
                            .remove(fragmentLoadingCurrent)
                            .commit();
                });
            }
        });
    }

    private static void getMessages() {
        try {
            store = session.getStore();
            store.connect(currentUserEMailAddress, currentUserPassword);
            folder = store.getFolder("inbox");
            folder.open(Folder.READ_WRITE);
            Message[] messagesAll = folder.getMessages();
            eMailMessagesAll = Arrays.asList(messagesAll);
            Collections.reverse(eMailMessagesAll);
        } catch (Exception e) {
        }
    }

    private static void loadMessages(int messageCount) {
        try {
            for (int messageToLoadIndex = eMailMessagesLoadedAllAmount; messageCount < LOAD_AMOUNT; messageCount++, messageToLoadIndex++) {
                Message receivedMessage = eMailMessagesAll.get(messageToLoadIndex);
                EMailMessage eMailMessage=(EMailMessage) loadMessage(receivedMessage);
                eMailMessagesLoadedCurrent.add(eMailMessage);
                eMailMessagesLoadedAllAmount++;
            }
            eMailMessagesLoadedAllAmount--;
        } catch (Exception e) {
            System.out.println(e.getClass().getName());
        }
    }

    public static void displayMessages(int eMailMessagesLayout) {
        if (!hasDisplayedMessages) {
            fragmentLoadingCurrent = new LoadingProgressBarCircle();
            activityCurrentFragmentManager.beginTransaction()
                    .add(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                    .commit();
            FragmentTransaction currentActivityFragmentTransaction = activityCurrentFragmentManager.beginTransaction();
            if (canDisplay(eMailMessagesLayout)) {
                loadMore = new LoadMore();
                currentActivityFragmentTransaction.add(eMailMessagesLayout, loadMore);
            } else {
                TextView noMessages = activityCurrent.findViewById(R.id.no_messages);
                noMessages.setVisibility(VISIBLE);
            }
            hasDisplayedMessages = true;
            currentActivityFragmentTransaction.remove(fragmentLoadingCurrent).commit();
        } else
            returnDisplayedMessages(eMailMessagesLayout);
    }

    public static void displayMoreMessages(int eMailMessagesLayout) {
        System.out.println(eMailMessagesLoadedCurrent.size());
        executor.execute((Runnable) () -> {
            if (eMailMessagesLoadedCurrent.isEmpty())
                loadMessages(0);
            activityCurrent.runOnUiThread((Runnable) () -> {
                FragmentTransaction currentActivityFragmentTransaction = activityCurrentFragmentManager.beginTransaction();
                if (canDisplay(eMailMessagesLayout)) {
                    currentActivityFragmentTransaction.remove(loadMore);
                    loadMore = new LoadMore();
                    currentActivityFragmentTransaction.add(eMailMessagesLayout, loadMore).commit();
                } else
                    currentActivityFragmentTransaction.remove(loadMore).commit();
            });
        });
    }

    private static void display(int eMailMessagesLayout) {
        canDisplay(eMailMessagesLayout);
    }

    private static boolean canDisplay(int eMailMessagesLayout) {
        FragmentTransaction currentActivityFragmentTransaction = activityCurrentFragmentManager.beginTransaction();
        Iterator<EMailMessage> eMailMessagesLoadedIterator = eMailMessagesLoadedCurrent.iterator();
        int messageCount = 0;
        while (eMailMessagesLoadedIterator.hasNext() && messageCount < DISPLAY_AMOUNT) {
            EMailMessage eMailMessage = eMailMessagesLoadedIterator.next();
            currentActivityFragmentTransaction.add(eMailMessagesLayout, eMailMessage);
            eMailMessagesDisplayed.add(eMailMessage);
            eMailMessagesLoadedIterator.remove();
            messageCount++;
        }
        currentActivityFragmentTransaction.commit();
        firstEMailMessageDisplayed = eMailMessagesDisplayed.get(0);
        if (messageCount > 0)
            return true;
        else
            return false;
    }

    public static void returnDisplayedMessages(int eMailMessagesLayout) {
        Iterator<EMailMessage> eMailMessagesDisplayedIterator = eMailMessagesDisplayed.iterator();
        FragmentTransaction currentActivityFragmentTransaction = activityCurrentFragmentManager.beginTransaction();
        while (eMailMessagesDisplayedIterator.hasNext()) {
            EMailMessage eMailMessage = eMailMessagesDisplayedIterator.next();
            currentActivityFragmentTransaction.add(eMailMessagesLayout, eMailMessage);
        }
        loadMore = new LoadMore();
        currentActivityFragmentTransaction.add(eMailMessagesLayout, loadMore).commit();
    }

    public static boolean hasDisplayedMessages() {
        return hasDisplayedMessages;
    }

    private static void removeEMailMessagesDisplayedToEMailMessagesLoaded() {
        Iterator<EMailMessage> eMailMessagesDisplayedIterator = eMailMessagesDisplayed.iterator();
        for (int messageIndex = 0; eMailMessagesDisplayedIterator.hasNext(); messageIndex++) {
            EMailMessage eMailMessage = eMailMessagesDisplayedIterator.next();
            eMailMessagesDisplayedIterator.remove();
            eMailMessagesLoadedCurrent.add(messageIndex, eMailMessage);
        }
    }

    private static void loadNewMessages() {
        removeEMailMessagesDisplayedToEMailMessagesLoaded();
        try {
            Date firstEMailMessageDisplayedSentDate=firstEMailMessageDisplayed.message.getSentDate();
            for (int messageIndex = 0; true; messageIndex++) {
                Message receivedMessage = eMailMessagesAll.get(messageIndex);
                Date receivedMessageSentDate=receivedMessage.getSentDate();
                if (receivedMessageSentDate.after(firstEMailMessageDisplayedSentDate)) {
                    EMailMessage eMailMessage =(EMailMessage) loadMessage(receivedMessage);
                    eMailMessagesLoadedCurrent.add(messageIndex, eMailMessage);
                    eMailMessagesLoadedAllAmount++;
                } else {
                    break;
                }
            }
        } catch (Exception e) {

        }
    }

    private static boolean hasNewMessages() {
        try {
            Message[] messagesAll = folder.getMessages();
            int messagesAllCount=messagesAll.length;
            int eMailMessagesAllCount=eMailMessagesAll.size();
            if (messagesAllCount>eMailMessagesAllCount) {
                eMailMessagesAll=Arrays.asList(messagesAll);
                Collections.reverse(eMailMessagesAll);
                return true;
            } else
                return false;
        } catch (Exception e) {
            return false;
        }
    }

    private static void removeEMailMessagesLayoutViews() {
        FragmentTransaction currentActivityFragmentTransaction = activityCurrentFragmentManager.beginTransaction();
        for (EMailMessage eMailMessage : eMailMessagesDisplayed) {
            currentActivityFragmentTransaction.remove(eMailMessage);
        }
        currentActivityFragmentTransaction.remove(loadMore).commit();
    }

    public static void refresh(int eMailMessagesLayout) {
        View mainMenuLoadingLayout = activityCurrent.findViewById(activityCurrentFragmentLoadingLayoutId);
        mainMenuLoadingLayout.bringToFront();
        fragmentLoadingCurrent = new LoadingProgressBarCircle();
        activityCurrentFragmentManager.beginTransaction()
                .add(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
        if (modeMainMenuDeleting)
            setModeMainMenuDeleting(false);
        executor.execute((Runnable) () -> {
        if (hasNewMessages()) {
            activityCurrent.runOnUiThread((Runnable) () -> {
                removeEMailMessagesLayoutViews();
                executor.execute((Runnable) () -> {
                    loadNewMessages();
                    activityCurrent.runOnUiThread((Runnable) () -> {
                        display(eMailMessagesLayout);
                        loadMore = new LoadMore();
                        activityCurrentFragmentManager.beginTransaction()
                                .add(eMailMessagesLayout, loadMore)
                                .commit();
                    });
                });
            });
        }
            activityCurrent.runOnUiThread((Runnable) () -> {
                activityCurrentFragmentManager.beginTransaction()
                        .remove(fragmentLoadingCurrent)
                        .commit();
                Fragment currentActivityShowMoreFragment = activityCurrentFragmentManager.findFragmentByTag("main menu show more");
                TextView refresh = currentActivityShowMoreFragment.getView().findViewById(R.id.main_menu_show_more_refresh);
                refresh.setClickable(true);
            });
        });
    }


    private static Fragment loadMessage(Message message) {
        try {
            System.out.println(1);
            Address[] messageFromAddresses = message.getFrom();
            System.out.println(2);
            int fromAddressesAmount = messageFromAddresses.length;
            String[] from = new String[fromAddressesAmount];
            for (int fromAddressCount = 0; fromAddressCount < messageFromAddresses.length; fromAddressCount++) {
                from[fromAddressCount] = messageFromAddresses[fromAddressCount].toString();
            }
            String subject = message.getSubject();
            String sentDate = formatSentDate(message.getSentDate());
            Fragment eMailMessage=new EMailMessage(message, from, subject, sentDate);
            return eMailMessage;
        } catch (Exception e) {
            StackTraceElement[] trace=e.getStackTrace();
            for (StackTraceElement element:trace) System.out.println(element);
            System.out.println(e.getClass().getName());
            return null;
        }
    }

    public static void loadEMailMessageContent() {
        fragmentLoadingCurrent = new LoadingProgressBarCircle();
        activityCurrentFragmentManager.beginTransaction()
                .add(activityCurrentFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
        executor.execute(new Runnable() {
            final HashMap<String, Object> eMailMessageContentTypeAndContent=new HashMap<>();
            public void run() {
                try {
                Part eMailMessageContent = eMailMessageCurrent.message;
                if (eMailMessageContent.isMimeType(MULTIPART)) {
                    System.out.println(eMailMessageContent.getContentType());
                    Multipart eMailMessageContentMultipart=(Multipart) eMailMessageContent.getContent();
                    int eMailMessageContentPartAmount=eMailMessageContentMultipart.getCount();
                    for (int i=0; i<eMailMessageContentPartAmount; i++) {
                        Part eMailMessageContentPart=eMailMessageContentMultipart.getBodyPart(i);
                        HashMap<String, Object> partContentTypeAndContent=loadEMailMessageContent(eMailMessageContentPart);
                        eMailMessageContentTypeAndContent.putAll(partContentTypeAndContent);
                    }
                } else {
                    HashMap<String, Object> messageContentTypeAndContent = loadEMailMessageContent(eMailMessageContent);
                    eMailMessageContentTypeAndContent.putAll(messageContentTypeAndContent);
                }
                activityCurrent.runOnUiThread((Runnable) () -> {
                    LinearLayout currentEMailMessageContentLayout= activityCurrent.findViewById(R.id.email_message_open_content_layout);
                    Iterator<Map.Entry<String, Object>> eMailMessageContentTypeAndContentIterator=eMailMessageContentTypeAndContent.entrySet().iterator();
                    while (eMailMessageContentTypeAndContentIterator.hasNext()) {
                        Map.Entry<String,Object> contentTypeAndContent=eMailMessageContentTypeAndContentIterator.next();
                        String contentType=contentTypeAndContent.getKey();
                        Object content=contentTypeAndContent.getValue();
                        if (contentType.equals(TEXT_PLAIN) && !eMailMessageCurrentHasContentHtml) {
                            TextView contentText=new TextView(activityCurrent);
                            contentText.setText((String) content);
                            contentText.setTextSize(20);
                            int black= activityCurrent.getColor(R.color.black);
                            contentText.setTextColor(black);
                            currentEMailMessageContentLayout.addView(contentText);
                        } else if (contentType.equals(TEXT_HTML)) {
                            WebView contentWeb=new WebView(activityCurrent);
                            contentWeb.setWebViewClient(new WebViewClient() {

                                public boolean shouldOverrideUrlLoading(WebView webView, WebResourceRequest request) {
                                    if (request!=null) {
                                        String currentUrlString = request.getUrl().toString();
                                        Uri currentUri = Uri.parse(currentUrlString);
                                        Intent intent = new Intent(Intent.ACTION_VIEW, currentUri);
                                        Intent intentChooser=Intent.createChooser(intent, "Select an app");
                                        activityCurrent.startActivity(intentChooser);
                                        return true;
                                    } else
                                        return false;
                                }

                                public WebResourceResponse shouldInterceptRequest(WebView webView, WebResourceRequest request) {
                                    try {
                                        String currentUrlString = request.getUrl().toString();
                                        if (currentUrlString.startsWith(HTTP)) {
                                            String correctUrlString = currentUrlString.replace(HTTP, HTTPS);
                                            URL correctUrl = new URL(correctUrlString);
                                            URLConnection correctUrlConnection = correctUrl.openConnection();
                                            String correctUrlContentType = correctUrlConnection.getContentType();
                                            String correctUrlContentEncoding = correctUrlConnection.getContentEncoding();
                                            InputStream correctUrlContentInputStream = correctUrlConnection.getInputStream();
                                            WebResourceResponse correctWebResourceResponse = new WebResourceResponse(correctUrlContentType,
                                                    correctUrlContentEncoding,
                                                    correctUrlContentInputStream);
                                            return correctWebResourceResponse;
                                        } else
                                            return super.shouldInterceptRequest(webView, request);
                                    } catch (Exception e) {
                                        return null;
                                    }
                                }
                            });
                            WebSettings contentWebSettings=contentWeb.getSettings();
                            contentWebSettings.setJavaScriptEnabled(true);
                            contentWeb.loadData((String) content, TEXT_HTML, "base64");
                            currentEMailMessageContentLayout.addView(contentWeb);
                        } else if (contentType.equals(IMAGE)) {
                            ImageView contentImage = new ImageView(activityCurrent);
                            contentImage.setImageBitmap((Bitmap) content);
                            currentEMailMessageContentLayout.addView(contentImage);
                        } else if (contentType.equals(UNKNOWN_CONTENT_TYPE)) {
                            TextView unknownContentType=new TextView(activityCurrent);
                            unknownContentType.setText(R.string.unknown_content_type);
                            unknownContentType.setTextSize(20);
                            int blue= activityCurrent.getColor(R.color.main_color);
                            unknownContentType.setTextColor(blue);
                            currentEMailMessageContentLayout.addView(unknownContentType);
                        }
                        activityCurrentFragmentManager.beginTransaction()
                                .remove(fragmentLoadingCurrent)
                                .commit();
                    }
                });
            } catch (Exception e) {

            }
        }
    });
    }

    private static HashMap<String, Object> loadEMailMessageContent(Part eMailMessageContentPart) throws Exception {
        if (eMailMessageContentPart.isMimeType(TEXT_PLAIN)) {
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            Object content = eMailMessageContentPart.getContent();
            partContentTypeAndContent.put(TEXT_PLAIN, content);
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(TEXT_HTML)) {
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            String htmlString = (String) eMailMessageContentPart.getContent();
            Object content = Base64.encodeToString(htmlString.getBytes(), Base64.DEFAULT);
            partContentTypeAndContent.put(TEXT_HTML, content);
            eMailMessageCurrentHasContentHtml =true;
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(IMAGE_PNG) || eMailMessageContentPart.isMimeType(IMAGE_JPEG)) {
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            InputStream contentStream = eMailMessageContentPart.getInputStream();
            Object content = BitmapFactory.decodeStream(new BufferedInputStream(contentStream));
            partContentTypeAndContent.put(IMAGE, content);
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(MULTIPART)) {
            Multipart eMailMessageContentMultipart=(Multipart) eMailMessageContentPart.getContent();
            int eMailMessageContentPartAmount=eMailMessageContentMultipart.getCount();
            HashMap<String, Object> partContentTypeAndContent=new HashMap<>();
            for (int i=0; i<eMailMessageContentPartAmount; i++) {
                Part contentPart=eMailMessageContentMultipart.getBodyPart(i);
                partContentTypeAndContent.putAll(loadEMailMessageContent(contentPart));
            }
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(MESSAGE_RFC822)) {
            HashMap<String, Object> partContentTypeAndContent=new HashMap<>();
            Part nestedMessageContent = (Part) eMailMessageContentPart.getContent();
            partContentTypeAndContent.putAll(loadEMailMessageContent(nestedMessageContent));
            return partContentTypeAndContent;
        }
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            partContentTypeAndContent.put(UNKNOWN_CONTENT_TYPE, null);
            System.out.println(eMailMessageContentPart.getContentType());
            return partContentTypeAndContent;
    }

    public static void disconnectFromNetwork() {
        executor.execute((Runnable) () -> {
            try {
                EMailService.hasLogOut=true;
                folder.close();
                store.close();
                EMailService.hasDisplayedMessages=false;
                eMailMessagesDisplayed.clear();
                eMailMessagesLoadedCurrent.clear();
                eMailMessagesLoadedAllAmount =0;
                if (modeMainMenuDeleting)
                    modeMainMenuDeleting =false;
                activityCurrent.runOnUiThread((Runnable) () -> {
                    Intent intent=new Intent(activityCurrent, MenuSignIn.class);
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
                    activityCurrent.startActivity(intent);
                });
            } catch (Exception e) {

            }
        });
    }

    public static void setEMailMessageCurrent(EMailMessage eMailMessage) {
        eMailMessageCurrent = eMailMessage;
    }

    public static EMailMessage getEMailMessageCurrent() {
        return eMailMessageCurrent;
    }

    public static String formatSentDate(Date date) {
        SimpleDateFormat sendDateFormat = new SimpleDateFormat("MMM, dd hh:mm");
        String sentDate = sendDateFormat.format(date);
        return sentDate;
    }

    public static int getCurrentMainMenuScrollY() {
        return currentMainMenuScrollY;
    }

    public static void setCurrentMainMenuScrollY(int mainMenuScrollY) {
        currentMainMenuScrollY=mainMenuScrollY;
    }

    public void onAnimationStart(Animator animator) {

    }

    public void onAnimationRepeat(Animator animator) {

    }

    public void onAnimationEnd(Animator animator) {

    }

    public void onAnimationCancel(Animator animator) {

    }

    public void onAnimationUpdate(ValueAnimator animator) {

    }


    public void onAnimationStart(Animation animation) {

    }

    public void onAnimationRepeat(Animation animation) {

    }

    public void onAnimationEnd(Animation animation) {

    }

    public void onClick(View view) {

    }

    public boolean onLongClick(View view) {
        return false;
    }

    public void onFocusChange(View view, boolean hasFocus) {

    }

    public void beforeTextChanged(CharSequence content, int start, int count, int after) {

    }

    public void onTextChanged(CharSequence content, int start, int count, int after) {

    }

    public void afterTextChanged(Editable content) {

    }

    public void onChildViewAdded(View parent, View child) {

    }

    public void onChildViewRemoved(View parent, View view) {

    }
}
