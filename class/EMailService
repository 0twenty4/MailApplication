package com.example.mailapplication;

import android.animation.Animator;
import android.animation.ValueAnimator;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentTransaction;
import android.support.v7.app.AppCompatActivity;
import android.util.Base64;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.Animation;
import android.webkit.WebResourceRequest;
import android.webkit.WebResourceResponse;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;
import static android.view.View.GONE;
import static android.view.View.VISIBLE;
import java.io.BufferedInputStream;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import javax.activation.CommandMap;
import javax.activation.MailcapCommandMap;
import javax.mail.Address;
import javax.mail.Flags;
import javax.mail.Folder;
import javax.mail.Message;
import javax.mail.Multipart;
import javax.mail.Part;
import javax.mail.Session;
import javax.mail.Store;
import javax.mail.Transport;

import java.io.InputStream;

public abstract class EMailService implements Animation.AnimationListener, ValueAnimator.AnimatorListener, ValueAnimator.AnimatorUpdateListener,
                                    View.OnClickListener, View.OnLongClickListener, View.OnFocusChangeListener{
    private static String currentUserLogin;
    private static String currentUserPassword;
    private static AppCompatActivity currentActivity;
    private static FragmentManager currentActivityFragmentManager;
    private static int currentActivityFragmentLoadingLayoutId;
    private static final Session session;
    private static Transport transport;
    private static Store store;
    private static Folder folder;
    private static List<Message> eMailMessagesAll;
    private static final ArrayList<EMailMessage> eMailMessagesLoadedCurrent = new ArrayList<>();
    private static final ArrayList<EMailMessage> eMailMessagesDisplayed = new ArrayList<>();
    private static int eMailMessagesLoadedAllAmount;
    private static final int LOAD_AMOUNT = 20;
    private static final int DISPLAY_AMOUNT = 15;
    private static EMailMessage firstEMailMessageDisplayed;
    private static Fragment fragmentLoadingCurrent;
    private static Fragment loadMore;
    private static ConfirmingDeletingMainMenu mainMenuConfirmingDeleting;
    private static final String MULTIPART = "multipart/*";
    private static final String TEXT_PLAIN = "text/plain";
    private static final String TEXT_HTML = "text/html";
    private static final String MESSAGE_RFC822 = "message/rfc822";
    private static final String IMAGE_PNG = "image/png";
    private static final String IMAGE_JPEG= "image/jpeg";
    private static final String IMAGE="image";
    private static final String HTTP="http://";
    private static final String HTTPS="https://";
    private static final String UNKNOWN_CONTENT_TYPE="unknown content type";
    private static boolean eMailMessageCurrentHasContentHtml;
    private static final ExecutorService executor=Executors.newSingleThreadExecutor();
    private static EMailMessage eMailMessageCurrent;
    private static EMailMessage eMailMessageToDelete;
    private static boolean hasDisplayedMessages;
    private static boolean hasLogOut;
    private static boolean modeMainMenuDeleting;
    private static boolean modeMainMenuConfirmingDeleting;
    private static boolean areEMailMessagesDisplayedTicked;
    private static final ArrayList<EMailMessage> eMailMessagesDisplayedTicked=new ArrayList<>();
    private static int currentMainMenuScrollY;


    static {
        Properties properties = new Properties();
        properties.put("mail.transport.protocol", "smtp");
        properties.put("mail.smtp.host", "smtp.gmail.com");
        properties.put("mail.smtp.port", "587");
        properties.put("mail.smtp.auth", "true");
        properties.put("mail.smtp.starttls.enable", "true");
        properties.put("mail.store.protocol", "imaps");
        properties.put("mail.imaps.host", "imap.gmail.com");
        properties.put("mail.imaps.port", "993");
        properties.put("mail.imaps.auth", "true");
        session = Session.getInstance(properties, null);
        MailcapCommandMap mailApplicationMailcapCommandMap = (MailcapCommandMap) CommandMap.getDefaultCommandMap();
        mailApplicationMailcapCommandMap.addMailcap("text/html;; x-java-content-handler=com.sun.mail.handlers.text_html");
        mailApplicationMailcapCommandMap.addMailcap("text/xml;; x-java-content-handler=com.sun.mail.handlers.text_xml");
        mailApplicationMailcapCommandMap.addMailcap("text/plain;; x-java-content-handler=com.sun.mail.handlers.text_plain");
        mailApplicationMailcapCommandMap.addMailcap("multipart/*;; x-java-content-handler=com.sun.mail.handlers.multipart_mixed");
        mailApplicationMailcapCommandMap.addMailcap("message/rfc822;; x-java-content-handler=com.mail.handlers.message_rfc822");
        CommandMap.setDefaultCommandMap(mailApplicationMailcapCommandMap);
    }

    public static AppCompatActivity getCurrentActivity() {
        return currentActivity;
    }

    public static int getCurrentActivityFragmentLoadingLayoutId() {
        return currentActivityFragmentLoadingLayoutId;
    }

    public static boolean hasLogOut() {
        return hasLogOut;
    }

    public static void setCurrentActivity(AppCompatActivity activity, int viewGroup) {
        currentActivity = activity;
        currentActivityFragmentLoadingLayoutId = viewGroup;
        currentActivityFragmentManager = activity.getSupportFragmentManager();
    }

    public static void setModeMainMenuDeleting(boolean isOn) {
        modeMainMenuDeleting =isOn;
        final int viewVisibility;
        if (isOn)
            viewVisibility=VISIBLE;
        else {
            areEMailMessagesDisplayedTicked=false;
            viewVisibility = GONE;
        }
        for (EMailMessage eMailMessage:eMailMessagesDisplayed) {
            ImageView eMailMessageDelete=eMailMessage.getView().findViewById(R.id.email_message_delete);
            eMailMessageDelete.setVisibility(viewVisibility);
            if (!isOn && eMailMessage.ticked) {
                eMailMessage.ticked = false;
                eMailMessagesDisplayedTicked.remove(eMailMessage);
                ImageView eMailMessageTick = eMailMessage.getView().findViewById(R.id.email_message_tick);
                eMailMessageTick.setVisibility(GONE);
                View eMailMessageView = eMailMessage.getView();
                int white = currentActivity.getColor(R.color.white);
                int grey = currentActivity.getColor(R.color.bright_grey);
                ValueAnimator eMailMessageViewAnimator = ValueAnimator.ofArgb(grey, white).setDuration(300);
                eMailMessageViewAnimator.addUpdateListener(new EMailService() {
                    public void onAnimationUpdate(ValueAnimator animator) {
                        eMailMessageView.setBackgroundColor((int) animator.getAnimatedValue());
                    }
                });
                eMailMessageViewAnimator.start();
            }
        }
        ImageView mainMenuTick=currentActivity.findViewById(R.id.main_menu_tick);
        mainMenuTick.setVisibility(viewVisibility);
        ImageView mainMenuDelete=currentActivity.findViewById(R.id.main_menu_delete);
        mainMenuDelete.setVisibility(viewVisibility);
    }

    public static boolean getModeMainMenuDeleting() {
        return modeMainMenuDeleting;
    }

    public static void setModeMainMenuConfirmingDeletingOn(EMailMessage eMailMessageToDeleteCertain) {
        if (eMailMessageToDeleteCertain!=null) {
            setConfirmingDeleting(true, eMailMessageToDeleteCertain);
        } else {
            int eMailMessagesDisplayedTickedAmount = eMailMessagesDisplayedTicked.size();
            if (eMailMessagesDisplayedTickedAmount > 1)
                setConfirmingDeleting(true, null);
            else {
                EMailMessage onlyOneEMailMessageToDelete = eMailMessagesDisplayed.get(0);
                setConfirmingDeleting(true, onlyOneEMailMessageToDelete);
            }
        }
    }

    public static void setModeMainMenuConfirmingDeletingOff() {
        setConfirmingDeleting(false, null);
    }

    private static void setConfirmingDeleting(boolean isOn, EMailMessage onlyOneEMailMessageToDelete) {
        modeMainMenuConfirmingDeleting = isOn;
        if (mainMenuConfirmingDeleting == null)
            mainMenuConfirmingDeleting = new ConfirmingDeletingMainMenu();
        int eMailMessagesDisplayedTickedAmount=eMailMessagesDisplayedTicked.size();
        final FragmentTransaction currentActivityFragmentTransaction = currentActivity.getSupportFragmentManager().beginTransaction();
        final View mainMenuClickLayout=currentActivity.findViewById(R.id.main_menu_root_click_layout);
        final boolean viewsClickable;
        if (isOn) {
            if (onlyOneEMailMessageToDelete==null) {
                if (eMailMessagesDisplayedTickedAmount>1)
                    mainMenuConfirmingDeleting.setOneMessage(false);
                else
                    mainMenuConfirmingDeleting.setOneMessage(true);
            } else
                mainMenuConfirmingDeleting.setOneMessage(true);
            viewsClickable = false;
            int mainMenuConfirmingDeletingLayoutId = R.id.main_menu_confirming_deleting_layout;
            currentActivityFragmentTransaction
                    .add(mainMenuConfirmingDeletingLayoutId, mainMenuConfirmingDeleting)
                    .commit();
            mainMenuClickLayout.setVisibility(VISIBLE);
            mainMenuClickLayout.bringToFront();
        } else {
            viewsClickable = true;
            currentActivityFragmentTransaction
                    .remove(mainMenuConfirmingDeleting)
                    .commit();
            mainMenuClickLayout.setVisibility(GONE);
        }
        int eMailMessagesDisplayedAmount = eMailMessagesDisplayed.size();
        for (int index = 0; index < eMailMessagesDisplayedAmount; index++) {
            EMailMessage eMailMessage = eMailMessagesDisplayed.get(index);
            eMailMessage.setClickable(viewsClickable);
        }
        ViewGroup mainMenuTop=currentActivity.findViewById(R.id.email_message_open_top);
        int mainMenuTopViewAmount=mainMenuTop.getChildCount();
        for (int index=0; index<mainMenuTopViewAmount; index++) {
            View mainMenuTopView=mainMenuTop.getChildAt(index);
            mainMenuTopView.setClickable(viewsClickable);
        }
    }

    public static boolean getModeMainMenuConfirmingDeleting() {
        return modeMainMenuConfirmingDeleting;
    }

    public static void setEMailMessagesDisplayedTicked(boolean ticked) {
        areEMailMessagesDisplayedTicked=ticked;
        final int white=currentActivity.getColor(R.color.white);
        final int grey=currentActivity.getColor(R.color.bright_grey);
        final ValueAnimator eMailMessageViewAnimator;
        if (ticked) {
            ArrayList<EMailMessage> eMailMessagesDisplayedNotTicked = new ArrayList<>();
            for (EMailMessage eMailMessage : eMailMessagesDisplayed) {
                if (!eMailMessage.ticked)
                    eMailMessagesDisplayedNotTicked.add(eMailMessage);
            }
            eMailMessageViewAnimator=ValueAnimator.ofArgb(white, grey).setDuration(300);
            for (EMailMessage eMailMessage:eMailMessagesDisplayedNotTicked) {
                eMailMessage.ticked = true;
                addEMailMessagesDisplayedTicked(eMailMessage);
                View eMailMessageView = eMailMessage.getView();
                ImageView eMailMessageTick = eMailMessageView.findViewById(R.id.email_message_tick);
                eMailMessageTick.setVisibility(VISIBLE);
                eMailMessageViewAnimator.addUpdateListener(new EMailService() {
                    public void onAnimationUpdate(ValueAnimator animator) {
                        eMailMessageView.setBackgroundColor((int) animator.getAnimatedValue());
                    }
                });
            }
            } else {
            eMailMessageViewAnimator=ValueAnimator.ofArgb(grey, white).setDuration(300);
            for (EMailMessage eMailMessage:eMailMessagesDisplayed) {
                eMailMessage.ticked=false;
                removeEMailMessagesDisplayedTicked(eMailMessage);
                View eMailMessageView=eMailMessage.getView();
                ImageView eMailMessageTick=eMailMessageView.findViewById(R.id.email_message_tick);
                eMailMessageTick.setVisibility(GONE);
                eMailMessageViewAnimator.addUpdateListener(new EMailService() {
                    public void onAnimationUpdate(ValueAnimator animator) {
                        eMailMessageView.setBackgroundColor((int) animator.getAnimatedValue());
                    }
                });
            }
        }
        eMailMessageViewAnimator.start();
    }

    public static boolean getAreEMailMessagesDisplayedTicked() {
        return areEMailMessagesDisplayedTicked;
    }

    public static int getEMailMessagesDisplayedTickedAmount() {
        return eMailMessagesDisplayedTicked.size();
    }

    public static void addEMailMessagesDisplayedTicked(EMailMessage eMailMessage) {
        eMailMessagesDisplayedTicked.add(eMailMessage);
    }

    public static void removeEMailMessagesDisplayedTicked(EMailMessage eMailMessage) {
        eMailMessagesDisplayedTicked.remove(eMailMessage);

    }

    public static void deleteMessage(EMailMessage eMailMessageToDelete) {
        delete(eMailMessageToDelete);
    }

    public static void deleteMessages() {
        delete(null);
    }

    public static void delete(EMailMessage eMailMessageToDelete) {
        setModeMainMenuConfirmingDeletingOff();
        ArrayList<EMailMessage> eMailMessagesToDelete=new ArrayList<>(eMailMessagesDisplayedTicked);
        setModeMainMenuDeleting(false);
        fragmentLoadingCurrent = new LoadingProgressBarCircle();
        currentActivityFragmentManager.beginTransaction()
                .add(currentActivityFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
        removeEMailMessagesLayoutViews();
        removeEMailMessagesDisplayedToEMailMessagesLoaded();
        executor.execute((Runnable) () -> {
            try {
                if (eMailMessageToDelete!=null) {
                    Message message = eMailMessageToDelete.message;
                    message.setFlag(Flags.Flag.DELETED, true);
                    eMailMessagesLoadedCurrent.remove(eMailMessageToDelete);
                    eMailMessagesLoadedAllAmount--;
                } else {
                    for (EMailMessage eMailMessage : eMailMessagesToDelete) {
                        Message message = eMailMessage.message;
                        message.setFlag(Flags.Flag.DELETED, true);
                        eMailMessagesLoadedCurrent.remove(eMailMessage);
                        eMailMessagesLoadedAllAmount--;
                    }
                }
                folder.close(true);
                folder.open(Folder.READ_WRITE);
                Message[] messagesAll=folder.getMessages();
                eMailMessagesAll=Arrays.asList(messagesAll);
                Collections.reverse(eMailMessagesAll);
                int messageCount=eMailMessagesLoadedCurrent.size();
                loadMessages(messageCount);
                System.out.println(messageCount);
                System.out.println(eMailMessagesLoadedCurrent.size());
            } catch (Exception e) {
                System.out.println(e.getClass().getName());
            }
            currentActivity.runOnUiThread((Runnable) () -> {
                int eMailMessagesLayout = R.id.main_menu_email_messages_layout;
                TextView noMessages = currentActivity.findViewById(R.id.no_messages);
                int noMessagesVisibility = noMessages.getVisibility();
                if (canDisplay(eMailMessagesLayout)) {
                    if (noMessagesVisibility == VISIBLE)
                        noMessages.setVisibility(GONE);
                    loadMore = new LoadMore();
                    currentActivityFragmentManager.beginTransaction()
                            .add(eMailMessagesLayout, loadMore)
                            .commit();
                } else {
                    if (noMessages.getVisibility() == GONE)
                        noMessages.setVisibility(VISIBLE);
                }
                currentActivityFragmentManager.beginTransaction()
                        .remove(fragmentLoadingCurrent)
                        .commit();
                System.out.println(eMailMessagesLoadedCurrent.size());
            });
        });
    }

    public static void loadUser(String login, String password) {
        currentUserLogin = login;
        currentUserPassword = password;
    }

    public static boolean fieldEmpty(TextView field) {
        return field.getText().toString().isEmpty();
    }

    public static boolean eMailAddressCorrect(TextView eMailAddress) {
        boolean loginCorrect = false;
        String loginString = eMailAddress.getText().toString();
        char[] charactersLoginString = loginString.toCharArray();
        LinkedList<Character> symbolsLoginString = new LinkedList<>();
        for (char character : charactersLoginString) {
            if (character != ' ') symbolsLoginString.add(character);
        }
        boolean hasNoSpace = true;
        if (!(charactersLoginString.length == symbolsLoginString.size())) {
            for (int i = 0; i < symbolsLoginString.size(); i++) {
                if (charactersLoginString[i] == ' ') {
                    hasNoSpace = false;
                    break;
                }
            }
        }
        if (hasNoSpace) {
            int atSignIndex = loginString.indexOf('@');
            if (atSignIndex != -1) {
                if (loginString.charAt(atSignIndex + 1) != '.') {
                    if (!loginString.substring(0, atSignIndex - 1).isEmpty()) {
                        boolean moreThanOneDotInRow = false;
                        for (int i = 0; i < atSignIndex - 1; i++) {
                            if (loginString.charAt(i) == '.' && loginString.charAt(i + 1) == '.') {
                                moreThanOneDotInRow = true;
                                break;
                            }
                        }
                        if (!moreThanOneDotInRow) {
                            String endOfLogin = loginString.substring(atSignIndex + 1);
                            if (endOfLogin.contains("gmail.com")
                                    || endOfLogin.contains("yandex.ru")
                                    || endOfLogin.contains("ya.ru")
                                    || endOfLogin.contains("mail.ru")) {
                                char lastSymbolLoginString = symbolsLoginString.getLast();
                                if (lastSymbolLoginString != '.')
                                    loginCorrect = true;
                            }
                        }
                    }
                }
            }
        }
        if (loginCorrect)
            return true;
        else
            return false;
    }

    public static boolean passwordCorrect(TextView password) {
        boolean passwordCorrect=false;
        String passwordString = password.getText().toString();
        if (passwordString.length() >= 8) {
            char[] charactersPasswordString = passwordString.toCharArray();
            ArrayList<Character> symbolsPasswordString = new ArrayList<>();
            for (char character : charactersPasswordString) {
                if (character != ' ') symbolsPasswordString.add(character);
            }
            boolean hasNoSpace = true;
            if (charactersPasswordString.length != symbolsPasswordString.size()) {
                for (int i = 0; i < symbolsPasswordString.size(); i++) {
                    if (charactersPasswordString[i] == ' ') {
                        hasNoSpace = false;
                        break;
                    }
                }
            }
            if (hasNoSpace) {
                boolean hasNumber = false;
                boolean hasLetter = false;
                boolean passwordMatch = false;
                for (char character : charactersPasswordString) {
                    if (Character.isDigit(character)) {
                        hasNumber = true;
                        if (hasLetter) {
                            passwordMatch = true;
                            break;
                        }
                    } else if (Character.isLetter(character)) {
                        hasLetter = true;
                        if (hasNumber) {
                            passwordCorrect = true;
                            break;
                        }
                    }
                }
            }
        }
        if (passwordCorrect)
            return true;
        else
            return false;
    }

    public static void connectToNetwork() {
        executor.execute((Runnable) () -> {
            try {
                currentActivity.runOnUiThread((Runnable) () -> {
                    fragmentLoadingCurrent = new Connecting();
                    currentActivityFragmentManager.beginTransaction()
                            .setCustomAnimations(R.anim.slide_from_right_to_middle, 0)
                            .add(currentActivityFragmentLoadingLayoutId, fragmentLoadingCurrent)
                            .commit();
                });
                transport = session.getTransport();
                transport.connect(currentUserLogin, currentUserPassword);
                currentActivity.runOnUiThread((Runnable) () -> {
                    fragmentLoadingCurrent = new LoadingEMailMessages();
                    currentActivityFragmentManager.beginTransaction()
                            .replace(currentActivityFragmentLoadingLayoutId, fragmentLoadingCurrent)
                            .commit();

                });
                getMessages();
                loadMessages(0);
                folder.hasNewMessages();
                currentActivity.runOnUiThread((Runnable) () -> {
                    Intent intent = new Intent(currentActivity, MainMenu.class);
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
                    currentActivity.startActivity(intent);
                });
            } catch (Exception e) {
                currentActivity.runOnUiThread((Runnable) () -> {
                    TextView accountNotExist = currentActivity.findViewById(R.id.account_not_exist);
                    accountNotExist.setVisibility(VISIBLE);
                    currentActivityFragmentManager.beginTransaction()
                            .setCustomAnimations(0, R.anim.slide_from_middle_to_right)
                            .remove(fragmentLoadingCurrent)
                            .commit();
                });
            }
        });
    }

    private static void getMessages() {
        try {
            store = session.getStore();
            store.connect(currentUserLogin, currentUserPassword);
            folder = store.getFolder("inbox");
            folder.open(Folder.READ_WRITE);
            Message[] messagesAll = folder.getMessages();
            eMailMessagesAll = Arrays.asList(messagesAll);
            Collections.reverse(eMailMessagesAll);
        } catch (Exception e) {
        }
    }

    private static void loadMessages(int messageCount) {
        try {
            for (int messageToLoadIndex = eMailMessagesLoadedAllAmount; messageCount < LOAD_AMOUNT; messageCount++, messageToLoadIndex++) {
                Message receivedMessage = eMailMessagesAll.get(messageToLoadIndex);
                EMailMessage eMailMessage = loadMessage(receivedMessage);
                eMailMessagesLoadedCurrent.add(eMailMessage);
                eMailMessagesLoadedAllAmount++;
            }
            eMailMessagesLoadedAllAmount--;
        } catch (Exception e) {

        }
    }

    public static void displayMessages(int eMailMessagesLayout) {
        if (!hasDisplayedMessages) {
            fragmentLoadingCurrent = new LoadingProgressBarCircle();
            currentActivityFragmentManager.beginTransaction()
                    .add(currentActivityFragmentLoadingLayoutId, fragmentLoadingCurrent)
                    .commit();
            FragmentTransaction currentActivityFragmentTransaction = currentActivityFragmentManager.beginTransaction();
            if (canDisplay(eMailMessagesLayout)) {
                loadMore = new LoadMore();
                currentActivityFragmentTransaction.add(eMailMessagesLayout, loadMore);
            } else {
                TextView noMessages = currentActivity.findViewById(R.id.no_messages);
                noMessages.setVisibility(VISIBLE);
            }
            hasDisplayedMessages = true;
            currentActivityFragmentTransaction.remove(fragmentLoadingCurrent).commit();
        } else
            returnDisplayedMessages(eMailMessagesLayout);
    }

    public static void displayMoreMessages(int eMailMessagesLayout) {
        System.out.println(eMailMessagesLoadedCurrent.size());
        executor.execute((Runnable) () -> {
            if (eMailMessagesLoadedCurrent.isEmpty())
                loadMessages(0);
            currentActivity.runOnUiThread((Runnable) () -> {
                FragmentTransaction currentActivityFragmentTransaction = currentActivityFragmentManager.beginTransaction();
                if (canDisplay(eMailMessagesLayout)) {
                    currentActivityFragmentTransaction.remove(loadMore);
                    loadMore = new LoadMore();
                    currentActivityFragmentTransaction.add(eMailMessagesLayout, loadMore).commit();
                } else
                    currentActivityFragmentTransaction.remove(loadMore).commit();
            });
        });
    }

    private static void display(int eMailMessagesLayout) {
        canDisplay(eMailMessagesLayout);
    }

    private static boolean canDisplay(int eMailMessagesLayout) {
        FragmentTransaction currentActivityFragmentTransaction = currentActivityFragmentManager.beginTransaction();
        Iterator<EMailMessage> eMailMessagesLoadedIterator = eMailMessagesLoadedCurrent.iterator();
        int messageCount = 0;
        while (eMailMessagesLoadedIterator.hasNext() && messageCount < DISPLAY_AMOUNT) {
            EMailMessage eMailMessage = eMailMessagesLoadedIterator.next();
            currentActivityFragmentTransaction.add(eMailMessagesLayout, eMailMessage);
            eMailMessagesLoadedIterator.remove();
            eMailMessagesDisplayed.add(eMailMessage);
            messageCount++;
        }
        currentActivityFragmentTransaction.commit();
        firstEMailMessageDisplayed = eMailMessagesDisplayed.get(0);
        if (messageCount > 0)
            return true;
        else
            return false;
    }

    public static void returnDisplayedMessages(int eMailMessagesLayout) {
        Iterator<EMailMessage> eMailMessagesDisplayedIterator = eMailMessagesDisplayed.iterator();
        FragmentTransaction currentActivityFragmentTransaction = currentActivityFragmentManager.beginTransaction();
        while (eMailMessagesDisplayedIterator.hasNext()) {
            EMailMessage eMailMessage = eMailMessagesDisplayedIterator.next();
            currentActivityFragmentTransaction.add(eMailMessagesLayout, eMailMessage);
        }
        loadMore = new LoadMore();
        currentActivityFragmentTransaction.add(eMailMessagesLayout, loadMore).commit();
    }

    public static boolean hasDisplayedMessages() {
        return hasDisplayedMessages;
    }

    private static void removeEMailMessagesDisplayedToEMailMessagesLoaded() {
        Iterator<EMailMessage> eMailMessagesDisplayedIterator = eMailMessagesDisplayed.iterator();
        for (int messageIndex = 0; eMailMessagesDisplayedIterator.hasNext(); messageIndex++) {
            EMailMessage eMailMessage = eMailMessagesDisplayedIterator.next();
            eMailMessagesDisplayedIterator.remove();
            eMailMessagesLoadedCurrent.add(messageIndex, eMailMessage);
        }
    }

    private static void loadNewMessages() {
        removeEMailMessagesDisplayedToEMailMessagesLoaded();
        try {
            Date firstEMailMessageDisplayedSentDate=firstEMailMessageDisplayed.message.getSentDate();
            for (int messageIndex = 0; true; messageIndex++) {
                Message receivedMessage = eMailMessagesAll.get(messageIndex);
                Date receivedMessageSentDate=receivedMessage.getSentDate();
                if (receivedMessageSentDate.after(firstEMailMessageDisplayedSentDate)) {
                    EMailMessage eMailMessage = loadMessage(receivedMessage);
                    eMailMessagesLoadedCurrent.add(messageIndex, eMailMessage);
                    eMailMessagesLoadedAllAmount++;
                } else {
                    break;
                }
            }
        } catch (Exception e) {

        }
    }

    private static boolean hasNewMessages() {
        try {
            Message[] messagesAll = folder.getMessages();
            int messagesAllCount=messagesAll.length;
            int eMailMessagesAllCount=eMailMessagesAll.size();
            if (messagesAllCount>eMailMessagesAllCount) {
                eMailMessagesAll=Arrays.asList(messagesAll);
                Collections.reverse(eMailMessagesAll);
                return true;
            } else
                return false;
        } catch (Exception e) {
            return false;
        }
    }

    private static void removeEMailMessagesLayoutViews() {
        FragmentTransaction currentActivityFragmentTransaction = currentActivityFragmentManager.beginTransaction();
        for (EMailMessage eMailMessage : eMailMessagesDisplayed) {
            currentActivityFragmentTransaction.remove(eMailMessage);
        }
        currentActivityFragmentTransaction.remove(loadMore).commit();
    }

    public static void refresh(int eMailMessagesLayout) {
        View mainMenuLoadingLayout = currentActivity.findViewById(currentActivityFragmentLoadingLayoutId);
        mainMenuLoadingLayout.bringToFront();
        fragmentLoadingCurrent = new LoadingProgressBarCircle();
        currentActivityFragmentManager.beginTransaction()
                .add(currentActivityFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
        if (modeMainMenuDeleting)
            setModeMainMenuDeleting(false);
        executor.execute((Runnable) () -> {
        if (hasNewMessages()) {
            currentActivity.runOnUiThread((Runnable) () -> {
                removeEMailMessagesLayoutViews();
                executor.execute((Runnable) () -> {
                    loadNewMessages();
                    currentActivity.runOnUiThread((Runnable) () -> {
                        display(eMailMessagesLayout);
                        loadMore = new LoadMore();
                        currentActivityFragmentManager.beginTransaction()
                                .add(eMailMessagesLayout, loadMore)
                                .commit();
                    });
                });
            });
        }
            currentActivity.runOnUiThread((Runnable) () -> {
                currentActivityFragmentManager.beginTransaction()
                        .remove(fragmentLoadingCurrent)
                        .commit();
                Fragment currentActivityShowMoreFragment = currentActivityFragmentManager.findFragmentByTag("main menu show more");
                TextView refresh = currentActivityShowMoreFragment.getView().findViewById(R.id.main_menu_show_more_refresh);
                refresh.setClickable(true);
            });
        });
    }


    private static EMailMessage loadMessage(Message message) {
        try {
            EMailMessage eMailMessage = new EMailMessage();
            Address[] messageFromAddresses = message.getFrom();
            int fromAddressesAmount = messageFromAddresses.length;
            String[] messageFrom = new String[fromAddressesAmount];
            for (int fromAddressCount = 0; fromAddressCount < messageFromAddresses.length; fromAddressCount++) {
                messageFrom[fromAddressCount] = messageFromAddresses[fromAddressCount].toString();
            }
            String messageSubject = message.getSubject();
            Date messageDate = message.getSentDate();
            String messageSentDate = formatSentDate(messageDate);
            eMailMessage.setData(message, messageFrom, messageSubject, messageSentDate);
            return eMailMessage;
        } catch (Exception e) {
            return null;
        }
    }

    public static void loadEMailMessageContent() {
        fragmentLoadingCurrent = new LoadingProgressBarCircle();
        currentActivityFragmentManager.beginTransaction()
                .add(currentActivityFragmentLoadingLayoutId, fragmentLoadingCurrent)
                .commit();
        executor.execute(new Runnable() {
            final HashMap<String, Object> eMailMessageContentTypeAndContent=new HashMap<>();
            public void run() {
                try {
                Part eMailMessageContent = eMailMessageCurrent.message;
                if (eMailMessageContent.isMimeType(MULTIPART)) {
                    System.out.println(eMailMessageContent.getContentType());
                    Multipart eMailMessageContentMultipart=(Multipart) eMailMessageContent.getContent();
                    int eMailMessageContentPartAmount=eMailMessageContentMultipart.getCount();
                    for (int i=0; i<eMailMessageContentPartAmount; i++) {
                        Part eMailMessageContentPart=eMailMessageContentMultipart.getBodyPart(i);
                        HashMap<String, Object> partContentTypeAndContent=loadEMailMessageContent(eMailMessageContentPart);
                        eMailMessageContentTypeAndContent.putAll(partContentTypeAndContent);
                    }
                } else {
                    HashMap<String, Object> messageContentTypeAndContent = loadEMailMessageContent(eMailMessageContent);
                    eMailMessageContentTypeAndContent.putAll(messageContentTypeAndContent);
                }
                currentActivity.runOnUiThread((Runnable) () -> {
                    LinearLayout currentEMailMessageContentLayout=currentActivity.findViewById(R.id.email_message_open_content_layout);
                    Iterator<Map.Entry<String, Object>> eMailMessageContentTypeAndContentIterator=eMailMessageContentTypeAndContent.entrySet().iterator();
                    while (eMailMessageContentTypeAndContentIterator.hasNext()) {
                        Map.Entry<String,Object> contentTypeAndContent=eMailMessageContentTypeAndContentIterator.next();
                        String contentType=contentTypeAndContent.getKey();
                        Object content=contentTypeAndContent.getValue();
                        if (contentType.equals(TEXT_PLAIN) && !eMailMessageCurrentHasContentHtml) {
                            TextView contentText=new TextView(currentActivity);
                            contentText.setText((String) content);
                            contentText.setTextSize(20);
                            int black=currentActivity.getColor(R.color.black);
                            contentText.setTextColor(black);
                            currentEMailMessageContentLayout.addView(contentText);
                        } else if (contentType.equals(TEXT_HTML)) {
                            WebView contentWeb=new WebView(currentActivity);
                            contentWeb.setWebViewClient(new WebViewClient() {

                                public boolean shouldOverrideUrlLoading(WebView webView, WebResourceRequest request) {
                                    if (request!=null) {
                                        String currentUrlString = request.getUrl().toString();
                                        Uri currentUri = Uri.parse(currentUrlString);
                                        Intent intent = new Intent(Intent.ACTION_VIEW, currentUri);
                                        Intent intentChooser=Intent.createChooser(intent, "Select an app");
                                        currentActivity.startActivity(intentChooser);
                                        return true;
                                    } else
                                        return false;
                                }

                                public WebResourceResponse shouldInterceptRequest(WebView webView, WebResourceRequest request) {
                                    try {
                                        String currentUrlString = request.getUrl().toString();
                                        if (currentUrlString.startsWith(HTTP)) {
                                            String correctUrlString = currentUrlString.replace(HTTP, HTTPS);
                                            URL correctUrl = new URL(correctUrlString);
                                            URLConnection correctUrlConnection = correctUrl.openConnection();
                                            String correctUrlContentType = correctUrlConnection.getContentType();
                                            String correctUrlContentEncoding = correctUrlConnection.getContentEncoding();
                                            InputStream correctUrlContentInputStream = correctUrlConnection.getInputStream();
                                            WebResourceResponse correctWebResourceResponse = new WebResourceResponse(correctUrlContentType,
                                                    correctUrlContentEncoding,
                                                    correctUrlContentInputStream);
                                            return correctWebResourceResponse;
                                        } else
                                            return super.shouldInterceptRequest(webView, request);
                                    } catch (Exception e) {
                                        return null;
                                    }
                                }
                            });
                            WebSettings contentWebSettings=contentWeb.getSettings();
                            contentWebSettings.setJavaScriptEnabled(true);
                            contentWeb.loadData((String) content, TEXT_HTML, "base64");
                            currentEMailMessageContentLayout.addView(contentWeb);
                        } else if (contentType.equals(IMAGE)) {
                            ImageView contentImage = new ImageView(currentActivity);
                            contentImage.setImageBitmap((Bitmap) content);
                            currentEMailMessageContentLayout.addView(contentImage);
                        } else if (contentType.equals(UNKNOWN_CONTENT_TYPE)) {
                            TextView unknownContentType=new TextView(currentActivity);
                            unknownContentType.setText(R.string.unknown_content_type);
                            unknownContentType.setTextSize(20);
                            int blue=currentActivity.getColor(R.color.main_color);
                            unknownContentType.setTextColor(blue);
                            currentEMailMessageContentLayout.addView(unknownContentType);
                        }
                        currentActivityFragmentManager.beginTransaction()
                                .remove(fragmentLoadingCurrent)
                                .commit();
                    }
                });
            } catch (Exception e) {

            }
        }
    });
    }

    private static HashMap<String, Object> loadEMailMessageContent(Part eMailMessageContentPart) throws Exception {
        if (eMailMessageContentPart.isMimeType(TEXT_PLAIN)) {
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            Object content = eMailMessageContentPart.getContent();
            partContentTypeAndContent.put(TEXT_PLAIN, content);
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(TEXT_HTML)) {
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            String htmlString = (String) eMailMessageContentPart.getContent();
            Object content = Base64.encodeToString(htmlString.getBytes(), Base64.DEFAULT);
            partContentTypeAndContent.put(TEXT_HTML, content);
            eMailMessageCurrentHasContentHtml =true;
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(IMAGE_PNG) || eMailMessageContentPart.isMimeType(IMAGE_JPEG)) {
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            InputStream contentStream = eMailMessageContentPart.getInputStream();
            Object content = BitmapFactory.decodeStream(new BufferedInputStream(contentStream));
            partContentTypeAndContent.put(IMAGE, content);
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(MULTIPART)) {
            Multipart eMailMessageContentMultipart=(Multipart) eMailMessageContentPart.getContent();
            int eMailMessageContentPartAmount=eMailMessageContentMultipart.getCount();
            HashMap<String, Object> partContentTypeAndContent=new HashMap<>();
            for (int i=0; i<eMailMessageContentPartAmount; i++) {
                Part contentPart=eMailMessageContentMultipart.getBodyPart(i);
                partContentTypeAndContent.putAll(loadEMailMessageContent(contentPart));
            }
            return partContentTypeAndContent;
        } else if (eMailMessageContentPart.isMimeType(MESSAGE_RFC822)) {
            HashMap<String, Object> partContentTypeAndContent=new HashMap<>();
            Part nestedMessageContent = (Part) eMailMessageContentPart.getContent();
            partContentTypeAndContent.putAll(loadEMailMessageContent(nestedMessageContent));
            return partContentTypeAndContent;
        }
            HashMap<String, Object> partContentTypeAndContent = new HashMap<>();
            partContentTypeAndContent.put(UNKNOWN_CONTENT_TYPE, null);
            System.out.println(eMailMessageContentPart.getContentType());
            return partContentTypeAndContent;
    }

    public static void disconnectFromNetwork() {
        executor.execute((Runnable) () -> {
            try {
                EMailService.hasLogOut=true;
                folder.close();
                store.close();
                transport.close();
                EMailService.hasDisplayedMessages=false;
                eMailMessagesDisplayed.clear();
                eMailMessagesLoadedCurrent.clear();
                eMailMessagesLoadedAllAmount =0;
                if (modeMainMenuDeleting)
                    modeMainMenuDeleting =false;
                currentActivity.runOnUiThread((Runnable) () -> {
                    Intent intent=new Intent(currentActivity, SignInMenu.class);
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
                    currentActivity.startActivity(intent);
                });
            } catch (Exception e) {

            }
        });
    }

    public static void setEMailMessageCurrent(EMailMessage eMailMessage) {
        eMailMessageCurrent = eMailMessage;
    }

    public static EMailMessage getEMailMessageCurrent() {
        return eMailMessageCurrent;
    }

    public static String formatSentDate(Date date) {
        SimpleDateFormat sendDateFormat = new SimpleDateFormat("MMM, dd hh:mm");
        String sentDate = sendDateFormat.format(date);
        return sentDate;
    }

    public static int getCurrentMainMenuScrollY() {
        return currentMainMenuScrollY;
    }

    public static void setCurrentMainMenuScrollY(int mainMenuScrollY) {
        currentMainMenuScrollY=mainMenuScrollY;
    }

    public void onAnimationStart(Animator animator) {

    }

    public void onAnimationRepeat(Animator animator) {

    }

    public void onAnimationEnd(Animator animator) {

    }

    public void onAnimationCancel(Animator animator) {

    }

    public void onAnimationUpdate(ValueAnimator animator) {

    }


    public void onAnimationStart(Animation animation) {

    }

    public void onAnimationRepeat(Animation animation) {

    }

    public void onAnimationEnd(Animation animation) {

    }

    public void onClick(View view) {

    }

    public boolean onLongClick(View view) {
        return false;
    }

    public void onFocusChange(View view, boolean hasFocus) {

    }
}











